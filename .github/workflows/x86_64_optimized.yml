# -------------------------------------------------
# ç»Ÿä¸€ç‰ˆ X86_64 OpenWrt ç¼–è¯‘å·¥ä½œæµ
# -------------------------------------------------
name: ğŸ’» X86_64 Optimized Build
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "é»˜è®¤ LAN åœ°å€"
        required: true
        default: "192.168.1.10"
        type: string
      root_password:
        description: "é»˜è®¤ root å¯†ç ï¼ˆå¯é€‰ï¼Œé»˜è®¤ passwordï¼‰"
        required: false
        default: "password"
        type: string
      docker:
        description: "ç¼–è¯‘ Docker"
        type: boolean
        default: true
      ssrp:
        description: "ç¼–è¯‘ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ç¼–è¯‘ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ç¼–è¯‘ Nikki"
        type: boolean
        default: true
      openclash:
        description: "ç¼–è¯‘ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "ç¼–è¯‘ Lucky"
        type: boolean
        default: true
      oaf:
        description: "ç¼–è¯‘ OpenAppFilter"
        type: boolean
        default: true
env:
  # ----------------------- åŸºç¡€ä¿¡æ¯ -----------------------
  REPO_URL: https://github.com/openwrt/openwrt   # OpenWrt å®˜æ–¹ä»“åº“
  REPO_BRANCH: openwrt-24.10
  CACHE_VER: v1                                   # æ”¹åŠ¨æ­¤å€¼å³å¯å¼ºåˆ¶å¤±æ•ˆç¼“å­˜
  CONFIG_FILE: configs/x86_64.config              # å¿…é¡»ä½äº **å½“å‰ä»“åº“æ ¹ç›®å½•**
  DIY_SCRIPT: scripts/diy-x86_64_test.sh         # å¿…é¡»ä½äº **å½“å‰ä»“åº“æ ¹ç›®å½•**
  CLASH_KERNEL: amd64
  # --------------------- é•œåƒ & Git åœ°å€ --------------------
  MIRROR: https://mirrors.tuna.tsinghua.edu.cn/openwrt
  GITEA: git.kejizero.online/zhao
  GITHUB: github.com
  # ------------------ å…¶å®ƒå¼€å…³ ---------------------------
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: X86_64
jobs:
  build:
    runs-on: ubuntu-24.04            # çº¦ 14â€¯GB ç£ç›˜ç©ºé—´
    timeout-minutes: 420             # 7â€¯h
    steps:
      # -------------------------------------------------
      # 0ï¸âƒ£ åŸºç¡€ç¯å¢ƒ
      # -------------------------------------------------
      - name: Setup environment
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          git config --global user.name actions
          git config --global user.email action@github.com
      # -------------------------------------------------
      # 1ï¸âƒ£ é‡Šæ”¾ç£ç›˜ç©ºé—´ + æ‰“å°æ£€æŸ¥
      # -------------------------------------------------
      - name: Free disk space
        uses: sbwml/actions@free-disk
      - name: Show free space after cleanup
        run: |
          echo "=== FREE SPACE BEFORE CHECKOUT ==="
          df -hT $GITHUB_WORKSPACE
          echo "=== TOPâ€‘10 DIR SIZES (workspace) ==="
          du -sh $GITHUB_WORKSPACE/* 2>/dev/null | sort -h | tail -n 20
      # -------------------------------------------------
      # 2ï¸âƒ£ æ£€å‡º **å½“å‰** ä»“åº“ï¼ˆåŒ…å« configs/ã€scripts/ï¼‰
      # -------------------------------------------------
      - name: Checkout workflow repository
        uses: actions/checkout@v4   # **ä¸æŒ‡å®š repository / ref**ï¼Œé»˜è®¤å°±æ˜¯æœ¬ä»“åº“
        with:
          fetch-depth: 1
      # -------------------------------------------------
      # 3ï¸âƒ£ æ‰‹åŠ¨å…‹éš† OpenWrt æºç åˆ°å­ç›®å½• openwrt/
      # -------------------------------------------------
      - name: Clone OpenWrt source
        run: |
          git clone --depth=1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
          echo "OPENWRT_PATH=$PWD/openwrt" >> $GITHUB_ENV
      # -------------------------------------------------
      # 4ï¸âƒ£ æ”¶é›†å…ƒä¿¡æ¯ï¼ˆcommitã€æ—¶é—´ç­‰ï¼‰ä¾› Release ä½¿ç”¨
      # -------------------------------------------------
      - name: Export repository meta
        id: meta
        run: |
          cd $OPENWRT_PATH
          echo "COMMIT_AUTHOR=$(git show -s --format='ä½œè€…: %an')"   >> $GITHUB_ENV
          echo "COMMIT_DATE=$(git show -s --format='æ—¶é—´: %ci')"     >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git show -s --format='å†…å®¹: %s')" >> $GITHUB_ENV
          echo "COMMIT_HASH=$(git rev-parse HEAD)"                >> $GITHUB_ENV
          echo "SOURCE_REPO=$(basename ${{ env.REPO_URL }})"       >> $GITHUB_ENV
      # -------------------------------------------------
      # 5ï¸âƒ£ ç¼“å­˜ï¼šdownloads / toolchain / feeds
      # -------------------------------------------------
      - name: Cache Downloads
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            dl-${{ runner.os }}-${{ env.CACHE_VER }}-
            dl-${{ runner.os }}-
      - name: Cache Toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host
            openwrt/staging_dir/toolchain-*
          key: toolchain-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            toolchain-${{ runner.os }}-${{ env.CACHE_VER }}-
            toolchain-${{ runner.os }}-
      - name: Cache Feeds
        uses: actions/cache@v4
        with:
          path: openwrt/feeds
          key: feeds-${{ runner.os }}-${{ env.CACHE_VER }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            feeds-${{ runner.os }}-${{ env.CACHE_VER }}-
            feeds-${{ runner.os }}-
      # -------------------------------------------------
      # 6ï¸âƒ£ ccacheï¼ˆåŠ é€ŸäºŒæ¬¡ç¼–è¯‘ï¼Œæ§åˆ¶ç£ç›˜å ç”¨ï¼‰
      # -------------------------------------------------
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ccache-${{ runner.os }}-${{ env.CACHE_VER }}
          max-size: 10G
          compress: true
      # -------------------------------------------------
      # 7ï¸âƒ£ å®‰è£… LLVMï¼ˆOpenWrt 24.10 æ¨è v14ï¼‰
      # -------------------------------------------------
      - name: Install LLVMv14)
        uses: sbwml/actions@install-llvm
        with:
          version: 14
      # -------------------------------------------------
      # 8ï¸âƒ£ å®‰è£… feedsï¼ˆè‡ªå®šä¹‰ feeds.confï¼‰
      # -------------------------------------------------
      - name: Install Feeds
        run: |
          cd $OPENWRT_PATH
          curl -fsSL -o feeds.conf.default \
            https://raw.githubusercontent.com/grandway2025/Actions-OpenWrt/main/Customize/feeds/feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      # -------------------------------------------------
      # 9ï¸âƒ£ **å…³é”®**ï¼šåŠ è½½è‡ªå®šä¹‰é…ç½® + è¿è¡Œ diy è„šæœ¬
      # -------------------------------------------------
      - name: Load Custom Configuration
        env:
          ENABLE_DOCKER: ${{ github.event.inputs.docker }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash }}
          ENABLE_LY: ${{ github.event.inputs.lucky }}
          ENABLE_OAF: ${{ github.event.inputs.oaf }}
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
        run: |
          echo "::group::Load custom configuration"
          cd $OPENWRT_PATH
          # â‘  ç¡®è®¤æˆ‘ä»¬çœŸçš„æ‹¿åˆ°äº† config æ–‡ä»¶ï¼ˆç»å¯¹è·¯å¾„ï¼Œæ°¸ä¸èµ°é”™ï¼‰
          if [[ ! -f "$GITHUB_WORKSPACE/${CONFIG_FILE}" ]]; then
            echo "::error ::Config file not found: $GITHUB_WORKSPACE/${CONFIG_FILE}"
            ls -Rla $GITHUB_WORKSPACE | head -n 200
            exit 1
          fi
          # â‘¡ æŠŠæ¨¡æ¿ .config æ”¾è¿›æºç æ ‘
          cp "$GITHUB_WORKSPACE/${CONFIG_FILE}" .config
          # â‘¢ ç»™äºˆæ‰§è¡Œæƒé™ï¼ˆGit ä¼šæŠŠ exec ä½ä¸¢æ‰ï¼Œæ‰‹åŠ¨è¡¥ä¸Šï¼‰
          chmod +x "$GITHUB_WORKSPACE/scripts"/*.sh
          chmod +x "$GITHUB_WORKSPACE/${DIY_SCRIPT}"
          # â‘£ è¿è¡Œè‡ªå®šä¹‰ DIY è„šæœ¬ï¼ˆå†…éƒ¨å·²ç»è¯»å–ä¸Šé¢çš„ env å˜é‡ï¼‰
          "$GITHUB_WORKSPACE/${DIY_SCRIPT}"
          # â‘¤ ï¼ˆå¦‚æœä½ è¿˜æœ‰ presetâ€‘* è„šæœ¬ï¼Œä¿æŒå…¼å®¹ï¼‰
          "$GITHUB_WORKSPACE/scripts/preset-mihimo-core.sh" $CLASH_KERNEL
          "$GITHUB_WORKSPACE/scripts/preset-adguard-core.sh" $CLASH_KERNEL
          # â‘¥ å†æ¬¡æ‰§è¡Œ make defconfigï¼Œç¡®ä¿æ‰€æœ‰é€‰é¡¹éƒ½å†™å…¥ .config
          make defconfig
          echo "::endgroup::"
          # ----------------- å¯¼å‡ºåç»­æ­¥éª¤éœ€è¦çš„å˜é‡ -----------------
          DEVICE_TARGET=$(grep ^CONFIG_TARGET_BOARD .config | cut -d'"' -f2)
          DEVICE_SUBTARGET=$(grep ^CONFIG_TARGET_SUBTARGET .config | cut -d'"' -f2)
          echo "DEVICE_TARGET=$DEVICE_TARGET"   >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
          echo "IP_ADDR=$LAN"               >> $GITHUB_ENV
          echo "ROOT_PASSWORD=$ROOT_PASSWORD" >> $GITHUB_ENV
          # è·å–å®˜æ–¹ OpenWrt æœ€æ–° Releaseï¼ˆåªè¯·æ±‚ä¸€æ¬¡ï¼‰
          latest_release=$(curl -fsSL "https://api.github.com/repos/${SOURCE_REPO}/releases/latest" \
            | jq -r .tag_name | sed 's/^v//')
          echo "latest_release=$latest_release" >> $GITHUB_ENV
      # -------------------------------------------------
      # 10ï¸âƒ£ ç¼–è¯‘åˆ†é˜¶æ®µï¼štools â†’ toolchain â†’ firmware
      # -------------------------------------------------
      - name: Build tools
        timeout-minutes: 120
        run: |
          echo "::group::Build tools"
          cd $OPENWRT_PATH
          make tools/install -j$(nproc) || make tools/install -j1 V=s
          echo "::endgroup::"
      - name: Build toolchain
        timeout-minutes: 150
        run: |
          echo "::group::Build toolchain"
          cd $OPENWRT_PATH
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s
          echo "::endgroup::"
      - name: Compile Firmware
        id: compile
        timeout-minutes: 180
        run: |
          echo "::group::Compile firmware"
          cd $OPENWRT_PATH
          export PATH="/usr/lib/ccache:$PATH"
          ccache -s
          make -j$(nproc) || make -j1 V=s
          ccache -s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
          echo "KERNEL=$(cat *.manifest | grep ^kernel | cut -d- -f2 | tr -d ' ')" >> $GITHUB_ENV
          echo "::endgroup::"
      # -------------------------------------------------
      # 11ï¸âƒ£ ç¼–è¯‘ç»“æŸåå†æ¬¡æ£€æŸ¥ç£ç›˜ï¼ˆé˜²æ­¢ä¸Šä¼ é˜¶æ®µå› ç©ºé—´ä¸è¶³å¤±è´¥ï¼‰
      # -------------------------------------------------
      - name: Check space usage (final)
        if: always()
        run: |
          echo "=== DISK USAGE AFTER COMPILATION ==="
          df -hT
          echo "=== BIGGEST DIRS (top 20) ==="
          du -sh $OPENWRT_PATH/* 2>/dev/null | sort -h | tail -n 20
      # -------------------------------------------------
      # 12ï¸âƒ£ æ‰“åŒ…äº§ç‰©ï¼ˆkernel.tar.xz + firmwareï¼‰
      # -------------------------------------------------
      - name: Organise files
        if: steps.compile.outputs.status == 'success'
        run: |
          echo "::group::Organise files"
          cd $OPENWRT_PATH/bin/targets/*/*
          cat sha256sums
          cp $OPENWRT_PATH/.config build.config
          mkdir -p kernel
          mv -f packages/* kernel
          tar -Jcf kernel.tar.xz kernel   # ä½¿ç”¨ xzï¼Œå‹ç¼©ç‡æ›´é«˜ä¸”å¤šæ ¸
          rm -rf packages feeds.buildinfo version.buildinfo kernel
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "::endgroup::"
      # -------------------------------------------------
      # 13ï¸âƒ£ï¼ˆå¯é€‰ï¼‰ä¸Šä¼  Bin ç›®å½•
      # -------------------------------------------------
      - name: Upload Bin Directory (optional)
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.OPENWRT_PATH }}/bin
      # -------------------------------------------------
      # 14ï¸âƒ£ ä¸Šä¼ å›ºä»¶è‡³ Artifactï¼ˆé Release åœºæ™¯ï¼‰
      # -------------------------------------------------
      - name: Upload Firmware to Artifact (when not releasing)
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
      # -------------------------------------------------
      # 15ï¸âƒ£ å‘å¸ƒ Releaseï¼ˆå½“ FIRMWARE_RELEASE ä¸º true æ—¶è§¦å‘ï¼‰
      # -------------------------------------------------
      - name: Upload Firmware to Release
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }}-${{ env.FIRMWARE_TAG }}-${{ env.latest_release }}
          tag: ${{ env.FIRMWARE_TAG }}-OpenWrt-${{ env.latest_release }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            **OpenWrt x86_64 Optimized Firmware**
            - **å¹³å°**: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
            - **æºç **: ${{ env.REPO_URL }}
            - **åˆ†æ”¯**: ${{ env.REPO_BRANCH }}
            - **å†…æ ¸**: ${{ env.KERNEL }}
            - **é»˜è®¤ LAN**: ${{ env.IP_ADDR }}
            - **é»˜è®¤å¯†ç **: ${{ env.ROOT_PASSWORD }}
            - **å®˜æ–¹ OpenWrt æœ€æ–° Tag**: ${{ env.latest_release }}
            ### ğŸ“’ ç¼–è¯‘ä¿¡æ¯
            - **æäº¤ä½œè€…**: ${{ env.COMMIT_AUTHOR }}
            - **æäº¤æ—¶é—´**: ${{ env.COMMIT_DATE }}
            - **æäº¤ä¿¡æ¯**: ${{ env.COMMIT_MESSAGE }}
            - **Commit SHA**: ${{ env.COMMIT``###å…³é”®
 æ”¹åŠ¨ç‚¹ | ä½œç”¨ |
|--------|------|
| **æ­¥éª¤ 2** `Checkout workflow repository`ï¼ˆä¸å¸¦ `repository` å‚æ•°ï¼‰ | æŠŠ **ä½ çš„ä»“åº“**ï¼ˆå« `configs/`ã€`scripts/`ï¼‰æ£€å‡ºåˆ°æ ¹ç›®å½•ï¼Œç¡®ä¿æ–‡ä»¶çœŸå®å­˜åœ¨ã€‚ |
| **æ­¥éª¤ 3** `git clone` æ‹‰å– OpenWrt æºç åˆ° `openwrt/` | ä¸ `checkout` å®Œå…¨åˆ†ç¦»ï¼Œé¿å…ç›¸äº’è¦†ç›–ã€‚ |
| **`Load Custom Configuration`** ä¸­ **ç»å¯¹è·¯å¾„** `cp "$GITHUB_WORKSPACE/${CONFIG_FILE}" .config` | ä¸å†ä¾èµ– `../`ï¼Œå³ä½¿å·¥ä½œç›®å½•å±‚çº§å˜åŒ–ä¹Ÿèƒ½å®šä½ã€‚ |
| **`chmod +x`** åªå¯¹å·¥ä½œåŒºçš„è„šæœ¬åšæƒé™æå‡ | é˜²æ­¢å›  `git checkout` ä¸¢å¤± `x` ä½å¯¼è‡´è¿è¡Œé”™è¯¯ã€‚ |
| **`latest_release`** ä½¿ç”¨ä¸€æ¬¡ `curl â€¦ /releases/latest` + `jq` å– tagï¼Œçœå»å¤šæ¬¡è¯·æ±‚ã€‚ |
| **ç£ç›˜æ£€æŸ¥**ï¼ˆ`Free disk space` + `Check space usage`) | é˜²æ­¢ GitHubâ€‘24.04ï¼ˆâ‰ˆ14â€¯GBï¼‰åœ¨ `make download` æœŸé—´è¢«è€—å°½ã€‚ |
| **ç¼“å­˜**ï¼ˆdownloads / toolchain / feedsï¼‰+ **ccache** | å¤§å¹…é™ä½äºŒæ¬¡ç¼–è¯‘æ—¶é—´å¹¶æ§åˆ¶ç£ç›˜å ç”¨ã€‚ |
---
## 4ï¸âƒ£ å¸¸è§â€œæ‰¾ä¸åˆ°æ–‡ä»¶â€è°ƒè¯•æŠ€å·§ï¼ˆå¦‚æœä½ ä»¥åè¿˜é‡åˆ°ç±»ä¼¼é—®é¢˜ï¼‰
1. **æ‰“å°å·¥ä½œåŒºç»“æ„**  
   ```yaml
   - name: List repository layout
     run: |
       echo "=== WORKSPACE ROOT ==="
       ls -Rla $GITHUB_WORKSPACE | head -n 200
