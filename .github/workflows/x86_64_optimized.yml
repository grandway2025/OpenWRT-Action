name: ğŸš€ Build OpenWrt (Optimized Build)
permissions:
  contents: write
  actions: read
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "ğŸ“ LAN åœ°å€"
        default: "192.168.1.200"
        required: true
      root_password:
        description: "ğŸ”‘ Root å¯†ç "
        default: "password"
        required: false
      docker:
        description: "ğŸ‹ Docker"
        type: boolean
        default: true
      ssrp:
        description: "ğŸš€ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ğŸŒ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ğŸ“¦ Nikki"
        type: boolean
        default: true
      openclash:
        description: "âš¡ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "ğŸ€ Lucky"
        type: boolean
        default: true
      oaf:
        description: "ğŸ›¡ï¸ OpenAppFilter"
        type: boolean
        default: true
      force_clean:
        description: "ğŸ§¹ å¼ºåˆ¶æ¸…ç†ç¼“å­˜"
        type: boolean
        default: false  
env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64_demo.sh
  FEEDS_CONF: feeds.conf.default
  CLASH_KERNEL: amd64
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  TZ: Asia/Shanghai
concurrency:
  group: openwrt-build-${{ github.ref }}
  cancel-in-progress: true
jobs:
  # ============================================
  # ğŸ”§ å·¥å…·é“¾é¢„ç¼–è¯‘ (æœ€ä¼˜ç­–ç•¥)
  # ============================================
  prepare-toolchain:
    name: ğŸ”§ é¢„ç¼–è¯‘å·¥å…·é“¾
    runs-on: ubuntu-24.04
    timeout-minutes: 280
    outputs:
      toolchain_ready: ${{ steps.toolchain.outputs.ready }}
    steps: 
      - name: ğŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      - name: ğŸ’¾ Setup Swap & Memory Optimization
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo tee -a /etc/sysctl.conf >/dev/null <<EOF
          vm.swappiness=10
          vm.vfs_cache_pressure=50
          vm.dirty_ratio=15
          vm.dirty_background_ratio=5
          EOF
          sudo sysctl -p
          echo "Memory status:"
          free -h
      - name: ğŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup
      - name: ğŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm
      - name: ğŸ“¥ Prepare OpenWrt Source
        run: |
          git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          
          # é…ç½®feeds
          if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
            cp "${{ github.workspace }}/feeds.conf.default" .
            echo "ğŸ“„ Using custom feeds.conf.default"
          else
            echo "::warning::feeds.conf.default not found, using upstream defaults."
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      - name: ğŸ¯ æ™ºèƒ½ç¼“å­˜é”®ç”Ÿæˆ
        run: |
          # åŸºäºé…ç½®æ–‡ä»¶çš„ç¨³å®šç¼“å­˜é”®
          CONFIG_HASH=$(sha256sum "${{ github.workspace }}/$CONFIG_FILE" | cut -c1-12)
          MONTH_KEY=$(date +'%Y%m')  # æœˆåº¦åˆ·æ–°
          CACHE_KEY="${{ env.REPO_BRANCH }}-${CONFIG_HASH}-${MONTH_KEY}"
          
          echo "CACHE_KEY=$CACHE_KEY" >> $GITHUB_ENV
          echo "ğŸ“‹ ç¼“å­˜ç­–ç•¥: $CACHE_KEY"
      - name: â˜ï¸ å·¥å…·é“¾ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
            openwrt/staging_dir/host*
          key: toolchain-${{ env.CACHE_KEY }}-v16
          restore-keys: |
            toolchain-${{ env.CACHE_KEY }}-
            toolchain-${{ env.REPO_BRANCH }}-
      - name: ğŸ¨ åº”ç”¨é…ç½®
        run: |
          cd "$OPENWRT_PATH"
          
          # åº”ç”¨é…ç½®å’Œè„šæœ¬
          cp "${{ github.workspace }}/$CONFIG_FILE" .config
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          make defconfig
      - name: ğŸ”¨ ç¼–è¯‘å·¥å…·é“¾
        id: toolchain
        run: |
          cd "$OPENWRT_PATH"
          
          echo "ğŸ”¨ å¼€å§‹å·¥å…·é“¾ç¼–è¯‘"
          make tools/compile -j$(nproc) || make tools/compile -j1 V=s
          make toolchain/compile -j$(nproc) || make toolchain/compile -j1 V=s
          
          echo "ready=true" >> $GITHUB_OUTPUT
  # ============================================
  # ğŸ—ï¸ ä¸»ç¼–è¯‘é˜¶æ®µ (ç²¾ç®€ä¼˜åŒ–)
  # ============================================
  build-firmware:
    name: ğŸ—ï¸ ç¼–è¯‘å›ºä»¶
    needs: prepare-toolchain
    if: needs.prepare-toolchain.outputs.toolchain_ready == 'true'
    runs-on: ubuntu-24.04
    timeout-minutes: 200
    steps:
      - name: ğŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      - name: ğŸ’¾ Setup Swap & Memory Optimization
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo tee -a /etc/sysctl.conf >/dev/null <<EOF
          vm.swappiness=10
          vm.vfs_cache_pressure=50
          vm.dirty_ratio=15
          vm.dirty_background_ratio=5
          EOF
          sudo sysctl -p
          echo "Memory status:"
          free -h
      - name: ğŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup
      - name: ğŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm
      - name: ğŸ“¥ Prepare OpenWrt Source
        run: |
          git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          
          if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
            cp "${{ github.workspace }}/feeds.conf.default" .
            echo "ğŸ“„ Using custom feeds.conf.default"
          else
            echo "::warning::feeds.conf.default not found, using upstream defaults."
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      - name: ğŸ¯ ç¼“å­˜é”®ç”Ÿæˆ
        run: |
          CONFIG_HASH=$(sha256sum "${{ github.workspace }}/$CONFIG_FILE" | cut -c1-12)
          MONTH_KEY=$(date +'%Y%m')
          CACHE_KEY="${{ env.REPO_BRANCH }}-${CONFIG_HASH}-${MONTH_KEY}"
          echo "CACHE_KEY=$CACHE_KEY" >> $GITHUB_ENV
      - name: â˜ï¸ å¤šå±‚ç¼“å­˜ç­–ç•¥
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
            openwrt/staging_dir/host*
          key: toolchain-${{ env.CACHE_KEY }}-v16
          restore-keys: |
            toolchain-${{ env.CACHE_KEY }}-
      - name: â˜ï¸ ä¸‹è½½ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: downloads-${{ env.REPO_BRANCH }}-${{ env.CACHE_KEY }}-v8
          restore-keys: |
            downloads-${{ env.REPO_BRANCH }}-
      - name: â˜ï¸ ccache ç¼–è¯‘ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: openwrt/.ccache
          key: ccache-${{ env.CACHE_KEY }}-${{ github.run_number }}-v12
          restore-keys: |
            ccache-${{ env.CACHE_KEY }}-
      - name: ğŸ¯ ccache é«˜æ€§èƒ½é…ç½®
        run: |
          cd "$OPENWRT_PATH"
          
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          
          mkdir -p "$CCACHE_DIR"
          
          # é«˜å‘½ä¸­ç‡é…ç½®
          ccache -M 25G -F 500000
          ccache --set-config=compression=true
          ccache --set-config=compression_level=1
          ccache --set-config=sloppiness=file_macro,locale,time_macros,include_file_ctime,file_stat_matches
          ccache --set-config=direct_mode=true
          ccache --set-config=base_dir="$PWD"
          ccache --cleanup || true
      - name: ğŸ¨ åº”ç”¨é…ç½®
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker == 'true' && 'y' || 'n' }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp == 'true' && 'y' || 'n' }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall == 'true' && 'y' || 'n' }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki == 'true' && 'y' || 'n' }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash == 'true' && 'y' || 'n' }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky == 'true' && 'y' || 'n' }}
          ENABLE_OAF: ${{ github.event.inputs.oaf == 'true' && 'y' || 'n' }}
        run: |
          cd "$OPENWRT_PATH"
          
          # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
          if [ -d "$GITHUB_WORKSPACE/files" ]; then
            mv $GITHUB_WORKSPACE/files $OPENWRT_PATH/files
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "${{ github.workspace }}/$CONFIG_FILE" .config
          
          # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
          if [ -d "${{ github.workspace }}/scripts" ]; then
            find "${{ github.workspace }}/scripts" -name "*.sh" -exec chmod +x {} \;
          fi
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          "${{ github.workspace }}/scripts/preset-mihimo-core.sh" "$CLASH_KERNEL"
          "${{ github.workspace }}/scripts/preset-adguard-core.sh" "$CLASH_KERNEL"
          
          # ç”Ÿæˆé…ç½®
          echo "âš™ï¸ Generating defconfig..."
          make defconfig
          
          # æå–ç›®æ ‡ä¿¡æ¯
          DEVICE_TARGET=$(awk -F'"' '/^CONFIG_TARGET_BOARD=/{print $2}' .config)
          DEVICE_SUBTARGET=$(awk -F'"' '/^CONFIG_TARGET_SUBTARGET=/{print $2}' .config)
          echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
      - name: ğŸ“¥ ä¸‹è½½ä¾èµ–
        run: |
          cd "$OPENWRT_PATH"
          make download -j16
      - name: ğŸ”¨ å¿«é€Ÿç¼–è¯‘å›ºä»¶
        timeout-minutes: 180
        run: |
          cd "$OPENWRT_PATH"
          
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ ($(date))"
          
          # æœ€ä¼˜åˆ†é˜¶æ®µç¼–è¯‘ç­–ç•¥
          echo "ğŸ”¨ Stage 1: Target compile"
          make target/compile -j$(nproc) || make target/compile -j1 V=s
          
          echo "ğŸ”¨ Stage 2: Package compile"
          JOBS=$(($(nproc) < 8 ? $(nproc) : 8))
          make package/compile -j$JOBS || make package/compile -j1 V=s
          
          echo "ğŸ”¨ Stage 3: Final assembly"
          make package/install target/install package/index -j$(nproc)
          
          echo "âœ… ç¼–è¯‘å®Œæˆ"
      - name: ğŸ“¦ æ•´ç†å›ºä»¶
        run: |
          cd "$OPENWRT_PATH/bin/targets"/*/*
          
          # æå–å†…æ ¸ç‰ˆæœ¬
          KERNEL_VERSION=$(grep "^kernel " *.manifest | head -1 | awk '{print $3}' | cut -d- -f1-2 2>/dev/null || echo "unknown")
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "$OPENWRT_PATH/.config" build.config
          
          # æ¸…ç†æ–‡ä»¶
          rm -f feeds.buildinfo version.buildinfo *.manifest sha256sums
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯
          cat > firmware_info.txt <<EOF
          OpenWrt å›ºä»¶ä¿¡æ¯
          ================
          ç‰ˆæœ¬: ${{ env.BUILD_DATE }}
          ç›®æ ‡: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          å†…æ ¸: $KERNEL_VERSION
          ç¼–è¯‘æ—¶é—´: $(date)
          LANåœ°å€: ${{ github.event.inputs.lan_addr }}
          é»˜è®¤å¯†ç : ${{ github.event.inputs.root_password }}
          
          åŒ…å«æ’ä»¶:
          Docker: ${{ github.event.inputs.docker }}
          SSRP: ${{ github.event.inputs.ssrp }}
          Passwall: ${{ github.event.inputs.passwall }}
          OpenClash: ${{ github.event.inputs.openclash }}
          nikki: ${{ github.event.inputs.nikki }},
          lucky: ${{ github.event.inputs.lucky }},
          oaf: ${{ github.event.inputs.oaf }}          
          EOF
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
      - name: ğŸ“Š æ€§èƒ½æŠ¥å‘Š
        if: always()
        run: |
          cd "$OPENWRT_PATH" 2>/dev/null || cd .
          
          echo "ğŸ“Š æ„å»ºæ€§èƒ½æŠ¥å‘Š"
          echo "================"
          echo "æ—¶é—´: $(date)"
          echo "åˆ†æ”¯: ${{ env.REPO_BRANCH }}"
          echo "ç›®æ ‡: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}"
          
          if command -v ccache >/dev/null 2>&1; then
            export CCACHE_DIR="$PWD/.ccache"
            echo ""
            echo "ğŸ¯ ccache ç»Ÿè®¡:"
            ccache -s | grep -E "(cache hit|cache miss|hit rate)" || ccache -s
            
            # è®¡ç®—å‘½ä¸­ç‡
            HITS=$(ccache -s | grep "cache hit" | awk '{sum += $4} END {print sum+0}')
            MISSES=$(ccache -s | grep "cache miss" | awk '{print $3}' || echo "1")
            if [ "$MISSES" != "0" ] && [ "$HITS" != "0" ]; then
              HIT_RATE=$(echo "scale=1; $HITS * 100 / ($HITS + $MISSES)" | bc -l 2>/dev/null || echo "N/A")
              echo "ğŸ“ˆ å‘½ä¸­ç‡: ${HIT_RATE}%"
            fi
          fi
      - name: ğŸš€ å‘å¸ƒå›ºä»¶
        if: env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }} â€¢ ${{ env.FIRMWARE_TAG }}
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## ğŸ¯ OpenWrt å›ºä»¶å‘å¸ƒ
            
            ### ğŸ“Š æ„å»ºä¿¡æ¯
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | **ç‰ˆæœ¬** | `${{ env.LATEST_RELEASE }}` |
            | **æ—¥æœŸ** | `${{ env.BUILD_DATE }}` |
            | **ç›®æ ‡** | `${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}` |
            | **å†…æ ¸** | `${{ steps.organize.outputs.kernel_version }}` |
            | **LAN IP** | `${{ github.event.inputs.lan_addr }}` |
            | **Password** | `${{ github.event.inputs.root_password }}` |
            
            ### ğŸ“¦ åŒ…å«çš„æ’ä»¶
            | æ’ä»¶ | çŠ¶æ€ |
            |------|------|
            | Docker | ${{ github.event.inputs.docker == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | ShadowSocksR Plus+ | ${{ github.event.inputs.ssrp == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Passwall | ${{ github.event.inputs.passwall == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenClash | ${{ github.event.inputs.openclash == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Nikki | ${{ github.event.inputs.nikki == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Lucky | ${{ github.event.inputs.lucky == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenAppFilter | ${{ github.event.inputs.oaf == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            
            ### ğŸ“¥ å®‰è£…æ–¹æ³•
            
            **UEFIå¯åŠ¨ (æ¨è)**:
            ```bash
            gunzip openwrt-*-generic-ext4-combined-efi.img.gz
            sudo dd if=openwrt-*-generic-ext4-combined-efi.img of=/dev/sdX bs=4M status=progress
