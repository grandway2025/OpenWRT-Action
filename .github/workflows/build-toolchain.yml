name: ðŸ”§ Build Toolchain

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt Version'
        required: true
        default: 'openwrt-23.05'
        type: choice
        options:
          - openwrt-23.05
          - master
      target:
        description: 'Target Platform'
        required: true
        default: 'x86/64'
        type: string
  
  # æ¯å‘¨æ—¥è‡ªåŠ¨æž„å»º
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥ 02:00 UTC
  
  # feeds æ›´æ–°æ—¶è§¦å‘
  repository_dispatch:
    types: [feeds-updated]

env:
  OPENWRT_VERSION: ${{ github.event.inputs.openwrt_version || 'openwrt-23.05' }}
  TARGET_PLATFORM: ${{ github.event.inputs.target || 'x86/64' }}
  TOOLCHAIN_DIR: /workdir/toolchain
  TZ: Asia/Shanghai

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    
    steps:
      # ============================================
      # 1. æ£€å‡ºä»£ç 
      # ============================================
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ============================================
      # 2. åˆå§‹åŒ–çŽ¯å¢ƒ
      # ============================================
      - name: ðŸ”§ Initialize Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget ccache
          
          sudo timedatectl set-timezone "$TZ"
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      # ============================================
      # 3. å…‹éš† OpenWrt æºç 
      # ============================================
      - name: ðŸ“¦ Clone OpenWrt Source
        working-directory: /workdir
        run: |
          git clone --depth 1 --branch $OPENWRT_VERSION \
            https://github.com/openwrt/openwrt.git openwrt
          
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      # ============================================
      # 4. æ›´æ–° Feeds
      # ============================================
      - name: ðŸ”„ Update Feeds
        working-directory: /workdir/openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ============================================
      # 5. ç”Ÿæˆå·¥å…·é“¾é…ç½®
      # ============================================
      - name: âš™ï¸ Generate Toolchain Config
        working-directory: /workdir/openwrt
        run: |
          # è§£æžç›®æ ‡å¹³å°
          TARGET=$(echo $TARGET_PLATFORM | cut -d'/' -f1)
          SUBTARGET=$(echo $TARGET_PLATFORM | cut -d'/' -f2)
          
          # ç”Ÿæˆæœ€å°é…ç½®
          cat > .config <<EOF
          CONFIG_TARGET_${TARGET}=y
          CONFIG_TARGET_${TARGET}_${SUBTARGET}=y
          CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_generic=y
          
          # å·¥å…·é“¾é€‰é¡¹
          CONFIG_DEVEL=y
          CONFIG_TOOLCHAINOPTS=y
          CONFIG_CCACHE=y
          
          # ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½
          # CONFIG_PACKAGE_luci is not set
          # CONFIG_PACKAGE_dnsmasq is not set
          EOF
          
          # å±•å¼€é…ç½®
          make defconfig
          
          echo "ðŸ“‹ Toolchain configuration:"
          grep "^CONFIG_TARGET" .config

      # ============================================
      # 6. ä¸‹è½½ä¾èµ–
      # ============================================
      - name: ðŸ“¥ Download Dependencies
        working-directory: /workdir/openwrt
        run: |
          make download -j$(nproc) V=s

      # ============================================
      # 7. ç¼–è¯‘å·¥å…·é“¾
      # ============================================
      - name: ðŸ”¨ Build Toolchain
        working-directory: /workdir/openwrt
        run: |
          echo "ðŸ”¨ Building toolchain..."
          echo "â° Start time: $(date '+%Y-%m-%d %H:%M:%S')"
          
          START_TIME=$(date +%s)
          
          # åªç¼–è¯‘å·¥å…·é“¾
          make tools/install -j$(nproc) V=s
          make toolchain/install -j$(nproc) V=s
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "âœ… Toolchain build completed!"
          echo "â±ï¸  Duration: $((DURATION/60))m $((DURATION%60))s"

      # ============================================
      # 8. æ‰“åŒ…å·¥å…·é“¾
      # ============================================
      - name: ðŸ“¦ Package Toolchain
        working-directory: /workdir/openwrt
        run: |
          echo "ðŸ“¦ Packaging toolchain..."
          
          # åˆ›å»ºå·¥å…·é“¾ç›®å½•
          mkdir -p $TOOLCHAIN_DIR
          
          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp -r staging_dir $TOOLCHAIN_DIR/
          cp -r build_dir/toolchain-* $TOOLCHAIN_DIR/ 2>/dev/null || true
          cp -r build_dir/host $TOOLCHAIN_DIR/ 2>/dev/null || true
          cp .config $TOOLCHAIN_DIR/
          
          # æ‰“åŒ…
          cd /workdir
          tar -czf toolchain-${OPENWRT_VERSION}-${TARGET_PLATFORM//\//-}.tar.gz toolchain/
          
          # æ˜¾ç¤ºä¿¡æ¯
          echo ""
          echo "ðŸ“Š Toolchain package info:"
          ls -lh toolchain-*.tar.gz
          echo ""
          echo "ðŸ“ Package size: $(du -sh toolchain-*.tar.gz | cut -f1)"

      # ============================================
      # 9. ä¸Šä¼ å·¥å…·é“¾
      # ============================================
      - name: ðŸ“¤ Upload Toolchain Artifact
        uses: actions/upload-artifact@v4
        with:
          name: toolchain-${{ env.OPENWRT_VERSION }}-${{ env.TARGET_PLATFORM }}
          path: /workdir/toolchain-*.tar.gz
          retention-days: 30
          compression-level: 0  # å·²ç»åŽ‹ç¼©è¿‡äº†

      # ============================================
      # 10. ç”Ÿæˆå·¥å…·é“¾ä¿¡æ¯
      # ============================================
      - name: ðŸ“‹ Generate Toolchain Info
        working-directory: /workdir/openwrt
        run: |
          cat > $TOOLCHAIN_DIR/toolchain-info.txt <<EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         Toolchain Information              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          OpenWrt Version: $OPENWRT_VERSION
          Target Platform: $TARGET_PLATFORM
          Build Date: $(date '+%Y-%m-%d %H:%M:%S')
          Build Host: $(uname -a)
          
          GCC Version: $(staging_dir/toolchain-*/bin/*-gcc --version | head -1)
          Binutils Version: $(staging_dir/toolchain-*/bin/*-ld --version | head -1)
          
          Package Size: $(du -sh /workdir/toolchain-*.tar.gz | cut -f1)
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          
          cat $TOOLCHAIN_DIR/toolchain-info.txt

      # ============================================
      # 11. åˆ›å»º Releaseï¼ˆå¯é€‰ï¼‰
      # ============================================
      - name: ðŸš€ Create Release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: toolchain-${{ env.OPENWRT_VERSION }}-${{ github.run_number }}
          name: Toolchain ${{ env.OPENWRT_VERSION }} - ${{ env.TARGET_PLATFORM }}
          body: |
            ## ðŸ”§ é¢„ç¼–è¯‘å·¥å…·é“¾
            
            - **OpenWrt ç‰ˆæœ¬**: ${{ env.OPENWRT_VERSION }}
            - **ç›®æ ‡å¹³å°**: ${{ env.TARGET_PLATFORM }}
            - **æž„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            
            ### ä½¿ç”¨æ–¹æ³•
            ```yaml
            - name: Download Toolchain
              uses: actions/download-artifact@v4
              with:
                name: toolchain-${{ env.OPENWRT_VERSION }}-${{ env.TARGET_PLATFORM }}
