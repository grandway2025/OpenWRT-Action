name: ðŸ”§ Build & Publish Toolchain (OpenWrt 24.10)
permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      targets:
        description: "ç›®æ ‡å¹³å° (é€—å·åˆ†éš”ï¼Œä¾‹å¦‚: x86_64,nanopi-r5s)"
        default: "x86_64"
        required: true
        type: string
  schedule:
    - cron: '0 2 * * 0'

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai
  CACHE_VERSION: v20250301

jobs:
  build-toolchain:
    name: ðŸ”§ Build ${{ matrix.target }} Toolchain
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJson('["' + replace(github.event.inputs.targets || 'x86_64', ',', '","') + '"]') }}

    steps:
      - name: âœ… Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”§ Setup Environment
        run: |
          sudo timedatectl set-timezone "$TZ"
          BUILD_DATE=$(date +'%Y.%m.%d')
          MONTH_KEY=$(date +'%Y%m')
          TARGET_KEY="${{ matrix.target }}"
          {
            echo "BUILD_DATE=$BUILD_DATE"
            echo "MONTH_KEY=$MONTH_KEY"
            echo "TARGET_KEY=$TARGET_KEY"
            echo "RELEASE_TAG=toolchain-$REPO_BRANCH"
            echo "CCACHE_KEY=toolchain-ccache-${CACHE_VERSION}-${REPO_BRANCH}-${TARGET_KEY}"
          } >> $GITHUB_ENV

      - name: ðŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk

      - name: ðŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup

      - name: ðŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm

      - name: ðŸ“¥ Clone OpenWrt
        run: |
          rm -rf openwrt
          git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          SOURCE_HASH=$(git rev-parse HEAD)
          echo "SOURCE_HASH=$SOURCE_HASH" >> $GITHUB_ENV

      - name: â˜ï¸ Cache Downloads
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: downloads-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-${{ env.TARGET_KEY }}-v1
          restore-keys: |
            downloads-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-
            downloads-${{ env.REPO_BRANCH }}-

      - name: â˜ï¸ Cache Feeds & Package Index
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/tmp/packagecache
          key: feeds-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-${{ env.MONTH_KEY }}-v1
          restore-keys: |
            feeds-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-
            feeds-${{ env.REPO_BRANCH }}-

      - name: â˜ï¸ Cache Toolchain (source hash)
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}-${{ env.TARGET_KEY }}-v1
          restore-keys: |
            toolchain-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-${{ env.TARGET_KEY }}-
            toolchain-${{ env.REPO_BRANCH }}-

      - name: â˜ï¸ Cache Build Host
        uses: actions/cache@v4
        with:
          path: openwrt/build_dir/host*
          key: host-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-${{ env.TARGET_KEY }}-v1
          restore-keys: |
            host-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-
            host-${{ env.REPO_BRANCH }}-

      - name: â˜ï¸ Cache ccache
        uses: actions/cache@v4
        with:
          path: openwrt/.ccache
          key: ${{ env.CCACHE_KEY }}-v1
          restore-keys: |
            toolchain-ccache-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-
            toolchain-ccache-${{ env.REPO_BRANCH }}-

      - name: ðŸ“š Configure Feeds
        run: |
          cd "$OPENWRT_PATH"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: âš™ï¸ Configure Target
        run: |
          cd "$OPENWRT_PATH"
          case "${{ matrix.target }}" in
            "x86_64")
              cat > .config <<'EOF'
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          EOF
              ;;
            "nanopi-r5s")
              cat > .config <<'EOF'
          CONFIG_TARGET_rockchip=y
          CONFIG_TARGET_rockchip_armv8=y
          EOF
              ;;
            *)
              echo "::error::æœªçŸ¥ç›®æ ‡: ${{ matrix.target }}"
              exit 1
              ;;
          esac
          make defconfig
          CONFIG_DIGEST=$(sha256sum .config | cut -c1-12)
          echo "CONFIG_DIGEST=$CONFIG_DIGEST" >> $GITHUB_ENV

      - name: ðŸ”§ Setup ccache
        run: |
          cd "$OPENWRT_PATH"
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          mkdir -p "$CCACHE_DIR"
          ccache --set-config=max_size=10G
          ccache --set-config=max_files=200000
          ccache --set-config=compression=true
          ccache --set-config=compiler_check=content
          ccache --set-config=hash_dir=false
          ccache -s || true

      - name: ðŸ§° Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: ðŸ” Check Existing Artifact
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ env.RELEASE_TAG }}"
          ASSET="toolchain-${{ matrix.target }}-${{ env.SOURCE_HASH }}.tar.gz"
          if gh release view "$TAG" --json assets --jq '.assets[].name' | grep -qx "$ASSET"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… Found $ASSET, skipping build."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ $ASSET not found, building."
          fi

      - name: ðŸ”¨ Build Toolchain
        if: steps.check.outputs.skip == 'false'
        run: |
          cd "$OPENWRT_PATH"
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          make -j$(nproc) tools/install
          make -j$(nproc) toolchain/install

      - name: ðŸ“¦ Package Toolchain
        if: steps.check.outputs.skip == 'false'
        id: package
        run: |
          cd "$OPENWRT_PATH"
          OUT="toolchain-${{ matrix.target }}-${{ env.SOURCE_HASH }}.tar.gz"
          tar -czf "../$OUT" staging_dir/toolchain-* build_dir/toolchain-*
          echo "artifact_path=../$OUT" >> $GITHUB_OUTPUT
          cat > "../toolchain-${{ matrix.target }}-${{ env.SOURCE_HASH }}.json" <<EOF
          {
            "branch": "${{ env.REPO_BRANCH }}",
            "target": "${{ matrix.target }}",
            "source_hash": "${{ env.SOURCE_HASH }}",
            "config_digest": "${{ env.CONFIG_DIGEST }}",
            "build_date": "${{ env.BUILD_DATE }}"
          }
          EOF

      - name: ðŸš€ Upload Toolchain (hashed)
        if: steps.check.outputs.skip == 'false'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: Toolchain â€¢ ${{ env.REPO_BRANCH }} â€¢ ${{ env.BUILD_DATE }}
          allowUpdates: true
          tag: ${{ env.RELEASE_TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            ${{ steps.package.outputs.artifact_path }}
            toolchain-${{ matrix.target }}-${{ env.SOURCE_HASH }}.json

      - name: ðŸ” Ensure 'latest' Alias
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ env.RELEASE_TAG }}"
          HASHED="toolchain-${{ matrix.target }}-${{ env.SOURCE_HASH }}.tar.gz"
          LATEST="toolchain-${{ matrix.target }}-latest.tar.gz"
          if gh release view "$TAG" >/dev/null 2>&1; then
            if ! gh release view "$TAG" --json assets --jq '.assets[].name' | grep -qx "$LATEST"; then
              if [ ! -f "$HASHED" ]; then
                gh release download "$TAG" -p "$HASHED" -D .
              fi
              cp "$HASHED" "$LATEST"
              gh release upload "$TAG" "$LATEST" --clobber
            else
              echo "Latest alias already present."
            fi
          else
            echo "::warning::Release tag $TAG not found."
          fi

      - name: ðŸ“Š Build Summary
        run: |
          echo "Target: ${{ matrix.target }}"
          echo "Branch: ${{ env.REPO_BRANCH }}"
          echo "Source hash: ${{ env.SOURCE_HASH }}"
          echo "Config digest: ${{ env.CONFIG_DIGEST }}"
          echo "Release tag: ${{ env.RELEASE_TAG }}"
          ls -lh .. | grep toolchain || true
