name: ğŸ’» Build OpenWrt (x86_64) - Turbo Cache Edition

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "ğŸ“ é»˜è®¤ LAN åœ°å€"
        default: "192.168.10.1"
        required: true
        type: string
      root_password:
        description: "ğŸ”‘ Root å¯†ç "
        default: "password"
        required: false
        type: string
      docker:
        description: "ğŸ‹ Docker æ”¯æŒ"
        type: boolean
        default: true
      ssrp:
        description: "ğŸš€ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ğŸŒ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ğŸ“¦ Nikki"
        type: boolean
        default: true
      openclash:
        description: "âš¡ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "ğŸ€ Lucky"
        type: boolean
        default: true
      oaf:
        description: "ğŸ›¡ï¸ OpenAppFilter"
        type: boolean
        default: true
      use_prebuilt_toolchain:
        description: "ğŸ”§ ä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾"
        type: boolean
        default: true

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64_demo.sh
  FEEDS_CONF: feeds.conf.default
  CLASH_KERNEL: amd64
  UPLOAD_ARTIFACTS: false
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive

concurrency:
  group: build-turbo-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: ğŸš€ Turbo Build OpenWrt
    runs-on: ubuntu-24.04
    timeout-minutes: 300  # å‡å°‘åˆ°5å°æ—¶

    outputs:
      firmware_path: ${{ steps.organize.outputs.firmware_path }}
      kernel_version: ${{ steps.organize.outputs.kernel_version }}
      cache_hit_rate: ${{ steps.cache-stats.outputs.hit_rate }}

    steps:
      # ============================================
      # ğŸ¯ 1. æè‡´ç¼“å­˜ä¼˜åŒ–ç¯å¢ƒè®¾ç½®
      # ============================================
      - name: ğŸš€ Setup Turbo Environment
        id: setup-env
        run: |
          sudo timedatectl set-timezone "$TZ"
          git config --global user.name "turbo-builder"
          git config --global user.email "turbo-builder@github.com"
          
          # ğŸ¯ æç®€æ—¶é—´é”® - æœ€å¤§åŒ–ç¼“å­˜å‘½ä¸­
          VERSION=$(date +'%Y.%m.%d')
          BUILD_ID="${{ github.run_number }}"
          FILE_DATE=$(date +'%Y.%m.%d-%H%M')
          
          # ğŸš€ æ¿€è¿›å¹¶è¡Œåº¦ - åŸºäºå†…å­˜ä¼˜åŒ–
          PROC_COUNT=$(nproc)
          MEM_GB=$(( $(free -m | awk '/^Mem:/{print $2}') / 1024 ))
          
          # æ›´æ¿€è¿›çš„å¹¶è¡Œç­–ç•¥
          if [ "$MEM_GB" -ge 14 ]; then
            JOBS=$((PROC_COUNT + 2))  # è¶…çº¿ç¨‹ä¼˜åŒ–
          elif [ "$MEM_GB" -ge 8 ]; then
            JOBS=$PROC_COUNT
          else
            JOBS=$((PROC_COUNT - 1))
          fi
          JOBS=$((JOBS < 2 ? 2 : JOBS))
          
          # ğŸ¯ è¶…ç¨³å®šç¼“å­˜é”®ç­–ç•¥ (60%+å‘½ä¸­ç‡)
          PLUGINS_CORE="${{ inputs.docker }},${{ inputs.ssrp }},${{ inputs.passwall }}"
          PLUGINS_EXT="${{ inputs.nikki }},${{ inputs.openclash }},${{ inputs.lucky }},${{ inputs.oaf }}"
          PLUGINS_HASH=$(echo "${PLUGINS_CORE}-${PLUGINS_EXT}" | sha256sum | cut -c1-6)  # ç¼©çŸ­ä¸º6ä½
          
          # ğŸ¯ æœˆåº¦ç¼“å­˜é”® - æ›´é•¿çš„ç¼“å­˜å‘¨æœŸ
          MONTH_KEY=$(date +'%Y%m')
          
          # ğŸ¯ ç¨³å®šæºç é”® - å‡å°‘å˜åŒ–
          STABLE_KEY="stable-24.10"
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "FILE_DATE=$FILE_DATE" >> $GITHUB_ENV
          echo "COMPILE_JOBS=$JOBS" >> $GITHUB_ENV
          echo "PLUGINS_HASH=$PLUGINS_HASH" >> $GITHUB_ENV
          echo "MONTH_KEY=$MONTH_KEY" >> $GITHUB_ENV
          echo "STABLE_KEY=$STABLE_KEY" >> $GITHUB_ENV
          
          echo "ğŸš€ Turbo Cache Strategy:"
          echo "  CPU: $PROC_COUNT cores â†’ $JOBS jobs"
          echo "  Memory: ${MEM_GB}GB" 
          echo "  Plugins: $PLUGINS_HASH"
          echo "  Month: $MONTH_KEY"
          echo "  Target Hit Rate: 60%+"

      - name: ğŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk

      - name: ğŸ’¾ Ultra Memory Optimization
        run: |
          # åˆ›å»ºæ›´å¤§çš„swapç”¨äºç¼“å­˜
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # æè‡´å†…å­˜ä¼˜åŒ–å‚æ•°
          sudo tee -a /etc/sysctl.conf >/dev/null << EOF
          vm.swappiness=5
          vm.vfs_cache_pressure=25
          vm.dirty_ratio=10
          vm.dirty_background_ratio=3
          vm.max_map_count=262144
          EOF
          sudo sysctl -p
          
          # ä¼˜åŒ–æ–‡ä»¶ç³»ç»Ÿ
          echo never | sudo tee /sys/kernel/mm/transparent_hugepage/enabled
          echo madvise | sudo tee /sys/kernel/mm/transparent_hugepage/defrag
          
          free -h

      - name: âœ… Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup
        
      - name: ğŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm
        
      - name: ğŸ“¥ Clone OpenWrt Source (Fast)
        run: |
          rm -rf openwrt
          # å¹¶è¡Œå…‹éš†ä¼˜åŒ–
          git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" openwrt --jobs=4
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          
          # ä½¿ç”¨ç¨³å®šçš„æºç æ ‡è¯†ç¬¦
          SOURCE_DATE=$(git log -1 --format=%cd --date=format:%Y%m%d)
          SOURCE_SHORT=$(git rev-parse --short=6 HEAD)
          SOURCE_STABLE="${SOURCE_DATE}-${SOURCE_SHORT}"
          echo "SOURCE_STABLE=$SOURCE_STABLE" >> $GITHUB_ENV
          echo "SOURCE_HASH=$(git rev-parse HEAD)" >> $GITHUB_ENV
          
          echo "ğŸ“¦ Source: $SOURCE_STABLE"

      # ============================================
      # ğŸš€ 2. æè‡´ç¼“å­˜ç­–ç•¥ - ç›®æ ‡60%+å‘½ä¸­ç‡
      # ============================================
      - name: â˜ï¸ Cache Downloads (Ultra Stable)
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: turbo-dl-${{ env.REPO_BRANCH }}-${{ env.MONTH_KEY }}-v8
          restore-keys: |
            turbo-dl-${{ env.REPO_BRANCH }}-${{ env.MONTH_KEY }}-
            turbo-dl-${{ env.REPO_BRANCH }}-

      - name: â˜ï¸ Cache Toolchain (Ultra Stable)
        if: ${{ inputs.force_clean != true }}
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: turbo-toolchain-${{ env.STABLE_KEY }}-${{ env.MONTH_KEY }}-v8
          restore-keys: |
            turbo-toolchain-${{ env.STABLE_KEY }}-${{ env.MONTH_KEY }}-
            turbo-toolchain-${{ env.STABLE_KEY }}-

      - name: â˜ï¸ Cache Staging (Ultra Stable)
        if: ${{ inputs.force_clean != true }}
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host*
            openwrt/staging_dir/hostpkg
            openwrt/staging_dir/packages
          key: turbo-staging-${{ env.STABLE_KEY }}-${{ env.MONTH_KEY }}-v8
          restore-keys: |
            turbo-staging-${{ env.STABLE_KEY }}-${{ env.MONTH_KEY }}-
            turbo-staging-${{ env.STABLE_KEY }}-

      - name: â˜ï¸ Cache Build Host (Stable)
        if: ${{ inputs.force_clean != true }}
        uses: actions/cache@v4
        with:
          path: |
            openwrt/build_dir/host*
          key: turbo-buildhost-${{ env.STABLE_KEY }}-${{ env.PLUGINS_HASH }}-${{ env.MONTH_KEY }}-v8
          restore-keys: |
            turbo-buildhost-${{ env.STABLE_KEY }}-${{ env.PLUGINS_HASH }}-
            turbo-buildhost-${{ env.STABLE_KEY }}-

      - name: â˜ï¸ Cache ccache (Hyper Aggressive)
        if: ${{ inputs.force_clean != true }}
        uses: actions/cache@v4
        with:
          path: openwrt/.ccache
          key: turbo-ccache-${{ env.STABLE_KEY }}-${{ env.PLUGINS_HASH }}-${{ env.MONTH_KEY }}-v8
          restore-keys: |
            turbo-ccache-${{ env.STABLE_KEY }}-${{ env.PLUGINS_HASH }}-
            turbo-ccache-${{ env.STABLE_KEY }}-

      - name: â˜ï¸ Cache Feeds (New Layer)
        if: ${{ inputs.force_clean != true }}
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/tmp/packagecache
          key: turbo-feeds-${{ env.REPO_BRANCH }}-${{ env.MONTH_KEY }}-v8
          restore-keys: |
            turbo-feeds-${{ env.REPO_BRANCH }}-${{ env.MONTH_KEY }}-
            turbo-feeds-${{ env.REPO_BRANCH }}-

      # ============================================
      # ğŸ”§ 3. é¢„ç¼–è¯‘å·¥å…·é“¾ (é»˜è®¤å¯ç”¨)
      # ============================================
      - name: ğŸ”§ Smart Prebuilt Toolchain
        if: ${{ inputs.use_prebuilt_toolchain == true }}
        continue-on-error: true
        run: |
          cd "$OPENWRT_PATH"
          echo "ğŸ” Smart toolchain detection..."
          
          # å¤šç§æ¥æºå°è¯•
          TOOLCHAIN_SOURCES=(
            "https://github.com/${{ github.repository }}/releases/download/toolchain-${REPO_BRANCH}/toolchain-x86_64-${SOURCE_STABLE}.tar.gz"
            "https://github.com/${{ github.repository }}/releases/download/toolchain-${REPO_BRANCH}/toolchain-x86_64-latest.tar.gz"
            "https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.xz"
          )
          
          for url in "${TOOLCHAIN_SOURCES[@]}"; do
            echo "ğŸŒ Trying: $(basename "$url")"
            if curl -fsSL --connect-timeout 30 --max-time 180 "$url" -o toolchain.tar.gz; then
              echo "ğŸ“¦ Extracting..."
              if tar -xf toolchain.tar.gz; then
                rm toolchain.tar.gz
                echo "TOOLCHAIN_PREBUILT=true" >> $GITHUB_ENV
                echo "âœ… Prebuilt toolchain ready"
                break
              fi
            fi
            rm -f toolchain.tar.gz
          done
          
          if [ "${TOOLCHAIN_PREBUILT:-false}" != "true" ]; then
            echo "TOOLCHAIN_PREBUILT=false" >> $GITHUB_ENV
            echo "âš ï¸ Will build toolchain from source"
          fi

      - name: ğŸ“š Configure Feeds (Cached)
        run: |
          cd "$OPENWRT_PATH"
          
          # æ£€æŸ¥feedsç¼“å­˜
          if [ ! -d "feeds/.git" ]; then
            echo "ğŸ”„ Updating feeds..."
            echo "ğŸ§¹ Cleaning feeds directory..."
          rm -rf feeds tmp/packagecache
          
          if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
            cp "${{ github.workspace }}/feeds.conf.default" .
            echo "ğŸ“„ Using custom feeds.conf.default"
          fi
            ./scripts/feeds update -a
            ./scripts/feeds install -a
          else
            echo "âœ… Using cached feeds"
            ./scripts/feeds install -a
          fi

      # ============================================
      # ğŸ¯ 4. è¶…æ¿€è¿›ccacheé…ç½®
      # ============================================
      - name: ğŸš€ Ultra ccache Setup
        run: |
          cd "$OPENWRT_PATH"
          
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          
          mkdir -p "$CCACHE_DIR"
          
          # ğŸš€ è¶…æ¿€è¿›ccacheé…ç½®
          ccache -M 20G                    # å¢åŠ åˆ°20GB
          ccache -F 200000                 # 20ä¸‡æ–‡ä»¶
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache --set-config=stats=true
          ccache --set-config=max_files=200000
          ccache --set-config=sloppiness=file_macro,locale,time_macros,include_file_ctime,include_file_mtime
          ccache --set-config=hash_dir=false
          ccache --set-config=hard_link=true
          ccache --set-config=file_clone=true
          
          echo "ğŸš€ Ultra ccache config:"
          ccache --show-config | grep -E "(max_size|max_files|compression)"
          echo "ğŸ“Š Initial stats:"
          ccache -s

      - name: ğŸ¨ Apply Configuration (Fast)
      - name: ğŸ¨ Apply Custom Configuration
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker == 'true' && 'y' || 'n' }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp == 'true' && 'y' || 'n' }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall == 'true' && 'y' || 'n' }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki == 'true' && 'y' || 'n' }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash == 'true' && 'y' || 'n' }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky == 'true' && 'y' || 'n' }}
          ENABLE_OAF: ${{ github.event.inputs.oaf == 'true' && 'y' || 'n' }}
        run: |
          cd "$OPENWRT_PATH"
          
          # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
          if [ -d "$GITHUB_WORKSPACE/files" ]; then
            cp -r "$GITHUB_WORKSPACE/files" .
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "${{ github.workspace }}/$CONFIG_FILE" .config
          
          # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ (å®‰å…¨æ‰§è¡Œ)
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          
          # æ‰§è¡Œé¢„è®¾è„šæœ¬ (æ£€æŸ¥å­˜åœ¨æ€§)
          for script in "preset-mihimo-core.sh" "preset-adguard-core.sh"; do
            if [ -f "${{ github.workspace }}/scripts/$script" ]; then
              chmod +x "${{ github.workspace }}/scripts/$script"
              "${{ github.workspace }}/scripts/$script" "$CLASH_KERNEL"
            fi
          done
          
          # ç”Ÿæˆé…ç½®
          echo "âš™ï¸ Generating defconfig..."
          make defconfig
          
          # æå–ç›®æ ‡ä¿¡æ¯
          DEVICE_TARGET=$(awk -F'"' '/^CONFIG_TARGET_BOARD=/{print $2}' .config || echo "x86")
          DEVICE_SUBTARGET=$(awk -F'"' '/^CONFIG_TARGET_SUBTARGET=/{print $2}' .config || echo "64")
          
          {
            echo "DEVICE_TARGET=$DEVICE_TARGET"
            echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET"
          } >> $GITHUB_ENV
          
          echo "ğŸ“± Target: $DEVICE_TARGET-$DEVICE_SUBTARGET"
          echo "ğŸ”§ Prebuilt Toolchain: ${TOOLCHAIN_PREBUILT:-false}"

      - name: ğŸ§¹ Smart Clean
        if: ${{ inputs.force_clean == true }}
        run: |
          cd "$OPENWRT_PATH"
          echo "ğŸ§¹ Smart cleaning..."
          cp .config .config.backup
          # åªæ¸…ç†å¿…è¦çš„éƒ¨åˆ†ï¼Œä¿ç•™ç¼“å­˜
          make clean
          cp .config.backup .config
          make defconfig

      - name: ğŸ“¥ Turbo Download
        run: |
          cd "$OPENWRT_PATH"
          echo "ğŸ“¥ Turbo downloading..."
          
          # è¶…æ¿€è¿›ä¸‹è½½ç­–ç•¥
          DOWNLOAD_JOBS=$((COMPILE_JOBS * 3))
          DOWNLOAD_JOBS=$((DOWNLOAD_JOBS > 32 ? 32 : DOWNLOAD_JOBS))
          
          if command -v aria2c >/dev/null 2>&1; then
            echo "ğŸš€ Using aria2 turbo mode"
            make download -j"$DOWNLOAD_JOBS" DOWNLOAD_TOOL="aria2c -x 8 -s 8 -k 1M" || make download -j1
          else
            make download -j"$DOWNLOAD_JOBS" || make download -j1
          fi

      # ============================================
      # ğŸ”¥ 5. ç»ˆæç¼–è¯‘ç­–ç•¥
      # ============================================
      - name: ğŸ”¥ Turbo Compile
        id: compile
        timeout-minutes: 360  # 6å°æ—¶
        run: |
          cd "$OPENWRT_PATH"
          
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export CONFIG_CCACHE=y
          export FORCE_UNSAFE_CONFIGURE=1
          
          echo "ğŸ”¥ Turbo compilation starting..."
          echo "âš¡ Jobs: $COMPILE_JOBS"
          echo "ğŸ”§ Prebuilt: ${TOOLCHAIN_PREBUILT:-false}"
          echo "ğŸ’¾ Memory: $(free -h | grep '^Mem:' | awk '{print $7}') available"
          
          # é¢„ç¼–è¯‘ç»Ÿè®¡
          echo "ğŸ“Š Pre-compile ccache:"
          ccache -s | grep -E "(hit rate|files in cache)" | head -3
          
          # ğŸš€ è¶…çº§å¹¶è¡Œç¼–è¯‘
          compile_success=false
          start_time=$(date +%s)
          
          # é˜¶æ®µ1: è¶…çº§å¹¶è¡Œ
          echo "ğŸš€ Phase 1: Hyper-parallel ($COMPILE_JOBS jobs)"
          if timeout 180m make -j"$COMPILE_JOBS" || make -j"$COMPILE_JOBS"; then
            compile_success=true
            echo "âœ… Hyper-parallel SUCCESS"
          else
            echo "âš ï¸ Hyper-parallel failed, trying reduced parallelism"
            
            # é˜¶æ®µ2: å‡å°‘å¹¶è¡Œåº¦
            REDUCED_JOBS=$((COMPILE_JOBS / 2))
            REDUCED_JOBS=$((REDUCED_JOBS < 2 ? 2 : REDUCED_JOBS))
            echo "ğŸ”„ Phase 2: Reduced parallel ($REDUCED_JOBS jobs)"
            
            if make -j"$REDUCED_JOBS"; then
              compile_success=true
              echo "âœ… Reduced parallel SUCCESS"
            else
              echo "ğŸ”„ Phase 3: Single-threaded fallback"
              if make -j1; then
                compile_success=true
                echo "âœ… Single-threaded SUCCESS"
              fi
            fi
          fi
          
          end_time=$(date +%s)
          compile_time=$((end_time - start_time))
          
          if [ "$compile_success" = "true" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "compile_time=$compile_time" >> $GITHUB_OUTPUT
            echo "âœ… BUILD SUCCESS in ${compile_time}s"
          else
            echo "âŒ ALL COMPILATION METHODS FAILED"
            echo "ğŸ“„ Error logs:"
            find . -name "*.log" -mmin -15 -exec tail -20 {} \; | head -100
            exit 1
          fi

      # ============================================
      # ğŸ“Š 6. ç¼“å­˜æ€§èƒ½åˆ†æ
      # ============================================
      - name: ğŸ“Š Cache Performance Analysis
        id: cache-stats
        if: always()
        run: |
          cd "$OPENWRT_PATH"
          
          echo "=== ğŸš€ TURBO CACHE PERFORMANCE REPORT ==="
          echo "Timestamp: $(date)"
          echo "Build Time: ${{ steps.compile.outputs.compile_time }}s"
          echo ""
          
          echo "ğŸ“ Cache Directory Sizes:"
          for dir in dl .ccache staging_dir feeds build_dir/toolchain-* build_dir/host*; do
            if [ -d "$dir" ]; then
              size=$(du -sh "$dir" 2>/dev/null | cut -f1)
              count=$(find "$dir" -type f 2>/dev/null | wc -l)
              echo "  $dir: $size ($count files)"
            fi
          done
          echo ""
          
          echo "ğŸ¯ ccache FINAL STATISTICS:"
          if command -v ccache >/dev/null 2>&1; then
            ccache -s
            echo ""
            
            # è¯¦ç»†å‘½ä¸­ç‡åˆ†æ
            HITS=$(ccache -s | grep "cache hit" | grep -o '[0-9]\+' | head -1)
            MISSES=$(ccache -s | grep "cache miss" | grep -o '[0-9]\+' | head -1)
            TOTAL_CALLS=$(ccache -s | grep "called for" | grep -o '[0-9]\+' | head -1)
            
            if [ -n "$HITS" ] && [ -n "$MISSES" ] && [ "$((HITS + MISSES))" -gt 0 ]; then
              HIT_RATE=$((HITS * 100 / (HITS + MISSES)))
              echo "ğŸ“ˆ CALCULATED HIT RATE: ${HIT_RATE}%"
              echo "hit_rate=$HIT_RATE" >> $GITHUB_OUTPUT
              
              if [ "$HIT_RATE" -ge 60 ]; then
                echo "ğŸ‰ EXCELLENT: Hit rate â‰¥60% TARGET ACHIEVED!"
              elif [ "$HIT_RATE" -ge 50 ]; then
                echo "âœ… GOOD: Hit rate â‰¥50%"
              else
                echo "âš ï¸ SUBOPTIMAL: Hit rate <50%"
              fi
              
              echo ""
              echo "ğŸ” Cache Efficiency Analysis:"
              echo "  Total Calls: ${TOTAL_CALLS:-N/A}"
              echo "  Cache Hits: $HITS"
              echo "  Cache Misses: $MISSES"
              echo "  Efficiency: ${HIT_RATE}%"
              
              # æ—¶é—´èŠ‚çœä¼°ç®—
              if [ -n "${{ steps.compile.outputs.compile_time }}" ] && [ "$HIT_RATE" -gt 0 ]; then
                SAVED_TIME=$(( ${{ steps.compile.outputs.compile_time }} * HIT_RATE / 100 ))
                echo "  Time Saved: ~${SAVED_TIME}s (estimated)"
              fi
            fi
          fi
          echo ""
          
          echo "ğŸ”§ Build Summary:"
          echo "  Prebuilt Toolchain: ${TOOLCHAIN_PREBUILT:-false}"
          echo "  Compile Jobs: $COMPILE_JOBS"
          echo "  Build Status: ${{ steps.compile.outputs.status }}"
          echo "  Total Time: ${{ steps.compile.outputs.compile_time }}s"
          echo "================================="

      - name: ğŸ“¦ Organize Firmware
        if: steps.compile.outputs.status == 'success'
        id: organize
        run: |
          cd "$OPENWRT_PATH/bin/targets"/*/*
          
          echo "=== Generated Files ==="
          ls -lah
          
          # è·å–å†…æ ¸ç‰ˆæœ¬
          KERNEL_VERSION="unknown"
          if ls *.manifest 1> /dev/null 2>&1; then
            KERNEL_VERSION=$(grep "^kernel " *.manifest | head -1 | awk '{print $3}' | cut -d- -f1-2 || echo "unknown")
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "$OPENWRT_PATH/.config" build.config
          
          # æ‰“åŒ…å†…æ ¸æ¨¡å—
          if [ -d packages ]; then
            tar -czf kernel-modules.tar.gz packages/
            rm -rf packages
          fi
          
          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          rm -f feeds.buildinfo version.buildinfo *.manifest
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯
          cat > firmware_info.json <<EOF
          {
            "build_date": "$BUILD_DATE",
            "build_version": "$BUILD_VERSION",
            "build_id": "$BUILD_ID",
            "kernel_version": "$KERNEL_VERSION",
            "source_hash": "$SOURCE_HASH",
            "toolchain_prebuilt": ${TOOLCHAIN_PREBUILT:-false},
            "target": "$DEVICE_TARGET",
            "subtarget": "$DEVICE_SUBTARGET",
            "lan_address": "${{ github.event.inputs.lan_addr }}",
            "plugins": {
              "docker": ${{ github.event.inputs.docker }},
              "ssrp": ${{ github.event.inputs.ssrp }},
              "passwall": ${{ github.event.inputs.passwall }},
              "openclash": ${{ github.event.inputs.openclash }},
              "nikki": ${{ github.event.inputs.nikki }},
              "lucky": ${{ github.event.inputs.lucky }},
              "oaf": ${{ github.event.inputs.oaf }}
            }
          }
          EOF
          
          {
            echo "firmware_path=$PWD"
            echo "kernel_version=$KERNEL_VERSION"
          } >> $GITHUB_OUTPUT
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

      - name: ğŸ“¤ Upload Artifacts
        if: ${{ steps.compile.outputs.status == 'success' && env.UPLOAD_ARTIFACTS == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-Turbo-${{ env.DEVICE_TARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 30

      - name: ğŸš€ Create Release
        if: ${{ steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' }}
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }} â€¢ Turbo â€¢ Hit Rate ${{ steps.cache-stats.outputs.hit_rate }}%
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}-turbo-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## ğŸš€ OpenWrt Turbo Build [${{ env.BUILD_ID }}] - Performance Edition
            
            ### âš¡ æ€§èƒ½æŒ‡æ ‡
            | æŒ‡æ ‡ | æ•°å€¼ | ç›®æ ‡ | çŠ¶æ€ |
            |------|------|------|------|
            | **ç¼“å­˜å‘½ä¸­ç‡** | `${{ steps.cache-stats.outputs.hit_rate }}%` | `60%+` | ${{ steps.cache-stats.outputs.hit_rate >= '60' && 'ğŸ‰ ä¼˜ç§€' || 'ğŸ”„ ä¼˜åŒ–ä¸­' }} |
            | **ç¼–è¯‘æ—¶é—´** | `${{ steps.compile.outputs.compile_time }}s` | `<7200s` | ${{ steps.compile.outputs.compile_time <= '7200' && 'âš¡ å¿«é€Ÿ' || 'â³ æ­£å¸¸' }} |
            | **å¹¶è¡Œä»»åŠ¡** | `${{ env.COMPILE_JOBS }}` | `Auto` | âœ… ä¼˜åŒ– |
            | **é¢„ç¼–è¯‘å·¥å…·é“¾** | `${TOOLCHAIN_PREBUILT:-false}` | `true` | ${{ env.TOOLCHAIN_PREBUILT == 'true' && 'âœ… å·²ç”¨' || 'âš ï¸ æœªç”¨' }} |
            
            ### ğŸ“Š æ„å»ºä¿¡æ¯
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | **æ—¥æœŸ** | `$(date +'%Y-%m-%d %H:%M:%S')` |
            | **ç›®æ ‡** | `${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}` |
            | **å†…æ ¸** | `${{ steps.organize.outputs.kernel_version }}` |
            | **æºç ** | `${{ env.SOURCE_STABLE }}` |
            | **LAN IP** | `${{ inputs.lan_addr }}` |
            | **å¯†ç ** | `${{ inputs.root_password }}` |
            
            ### ğŸš€ Turbo ä¼˜åŒ–ç‰¹æ€§
            - ğŸ¯ **60%+ç¼“å­˜å‘½ä¸­ç‡** - æœˆåº¦ç¼“å­˜ç­–ç•¥
            - âš¡ **20GB ccache** - è¶…å¤§ç¼“å­˜ç©ºé—´  
            - ğŸ”§ **æ™ºèƒ½é¢„ç¼–è¯‘å·¥å…·é“¾** - è‡ªåŠ¨æ£€æµ‹å¤šæº
            - ğŸš€ **è¶…çº¿ç¨‹å¹¶è¡Œ** - å†…å­˜è‡ªé€‚åº”è°ƒåº¦
            - ğŸ“¦ **Feedsç¼“å­˜** - æ–°å¢ç¼“å­˜å±‚
            - ğŸ’¾ **12GB Swap** - æè‡´å†…å­˜ä¼˜åŒ–
            - ğŸ® **æ–‡ä»¶ç³»ç»Ÿè°ƒä¼˜** - é€æ˜å¤§é¡µä¼˜åŒ–
            
            ### ğŸ“¦ æ’ä»¶é…ç½®
            - Docker: ${{ inputs.docker == 'true' && 'âœ…' || 'âŒ' }}
            - SSR+: ${{ inputs.ssrp == 'true' && 'âœ…' || 'âŒ' }}  
            - Passwall: ${{ inputs.passwall == 'true' && 'âœ…' || 'âŒ' }}
            - OpenClash: ${{ inputs.openclash == 'true' && 'âœ…' || 'âŒ' }}
            - Lucky: ${{ inputs.lucky == 'true' && 'âœ…' || 'âŒ' }}
            - Nikki: ${{ inputs.nikki == 'true' && 'âœ…' || 'âŒ' }}
            - OAF: ${{ inputs.oaf == 'true' && 'âœ…' || 'âŒ' }}
            
            ---
            ğŸ¯ **ç¼“å­˜ç›®æ ‡**: 60%+ å‘½ä¸­ç‡ (å½“å‰: ${{ steps.cache-stats.outputs.hit_rate }}%)  
            âš¡ **é€Ÿåº¦æå‡**: é¢„è®¡å‡å°‘ç¼–è¯‘æ—¶é—´50-70%  
            ğŸ”§ **è‡ªåŠ¨ä¼˜åŒ–**: æ™ºèƒ½å¹¶è¡Œåº¦ + é¢„ç¼–è¯‘å·¥å…·é“¾
