name: ğŸ’» Build OpenWrt (x86_64) - Optimized
permissions:
  contents: write
  actions: read
on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "ğŸ“ é»˜è®¤ LAN åœ°å€"
        default: "192.168.1.10"
        required: true
        type: string
      root_password:
        description: "ğŸ”‘ Root å¯†ç "
        default: "password"
        required: false
        type: string
      docker:
        description: "ğŸ‹ Docker æ”¯æŒ"
        type: boolean
        default: true
      ssrp:
        description: "ğŸš€ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ğŸŒ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ğŸ“¦ Nikki"
        type: boolean
        default: true
      openclash:
        description: "âš¡ OpenClash"
        type: boolean
        default: true
      lucky:
        description: "ğŸ€ Lucky"
        type: boolean
        default: true
      oaf:
        description: "ğŸ›¡ï¸ OpenAppFilter"
        type: boolean
        default: true
      use_prebuilt_toolchain:
        description: "ğŸ”§ ä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾"
        type: boolean
        default: true
env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64_demo.sh
  FEEDS_CONF: feeds.conf.default
  CLASH_KERNEL: amd64
  UPLOAD_ARTIFACTS: false
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive
concurrency:
  group: build-${{ github.ref }}-${{ github.event.inputs.lan_addr }}
  cancel-in-progress: false
jobs:
  build:
    name: ğŸ—ï¸ Build OpenWrt
    runs-on: ubuntu-24.04
    timeout-minutes: 480  # å‡å°‘åˆ°8å°æ—¶
    outputs:
      firmware_path: ${{ steps.organize.outputs.firmware_path }}
      kernel_version: ${{ steps.organize.outputs.kernel_version }}
    steps:
      # ============================================
      # 1. ç¯å¢ƒåˆå§‹åŒ–
      # ============================================
      - name: ğŸ”§ Setup Environment
        id: env
        run: |
          sudo timedatectl set-timezone "$TZ"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ„å»ºä¿¡æ¯
          VERSION=$(date +'%Y.%m.%d')
          BUILD_ID="${{ github.run_number }}-${GITHUB_SHA::7}"
          FILE_DATE=$(date +'%Y.%m.%d-%H%M')
          
          # ä¼˜åŒ–å¹¶è¡Œåº¦è®¡ç®—
          PROC_COUNT=$(nproc)
          MEM_GB=$(($(free -m | awk '/^Mem:/{print $2}') / 1024))
          JOBS=$((MEM_GB / 3))  # æ›´ä¿å®ˆçš„å†…å­˜ä½¿ç”¨
          JOBS=$((JOBS > PROC_COUNT ? PROC_COUNT : JOBS))
          JOBS=$((JOBS < 1 ? 1 : JOBS))
          
          # æ™ºèƒ½ç¼“å­˜é”®ç”Ÿæˆ
          PLUGINS_KEY="${{ github.event.inputs.docker }}-${{ github.event.inputs.ssrp }}-${{ github.event.inputs.passwall }}-${{ github.event.inputs.nikki }}-${{ github.event.inputs.openclash }}-${{ github.event.inputs.lucky }}-${{ github.event.inputs.oaf }}"
          PLUGINS_HASH=$(echo "$PLUGINS_KEY" | sha256sum | cut -c1-12)
          
          # æœˆåº¦é”®ï¼ˆæ›´é•¿çš„ç¼“å­˜å‘¨æœŸï¼‰
          MONTH_KEY=$(date +'%Y%m')
          
          # å¯¼å‡ºç¯å¢ƒå˜é‡
          {
            echo "BUILD_VERSION=$VERSION"
            echo "BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S')"
            echo "BUILD_ID=$BUILD_ID"
            echo "FILE_DATE=$FILE_DATE"
            echo "COMPILE_JOBS=$JOBS"
            echo "PLUGINS_HASH=$PLUGINS_HASH"
            echo "MONTH_KEY=$MONTH_KEY"
          } >> $GITHUB_ENV
      # ============================================
      # 2. ç³»ç»Ÿä¼˜åŒ–
      # ============================================
      - name: ğŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk
        
      - name: ğŸ’¾ Setup Swap & Memory Optimization
        run: |
          # åˆ›å»ºæ›´å¤§çš„äº¤æ¢æ–‡ä»¶
          sudo fallocate -l 16G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # ä¼˜åŒ–ç³»ç»Ÿå‚æ•°
          sudo tee -a /etc/sysctl.conf >/dev/null <<EOF
          vm.swappiness=5
          vm.vfs_cache_pressure=30
          vm.dirty_ratio=10
          vm.dirty_background_ratio=3
          vm.overcommit_memory=1
          EOF
          sudo sysctl -p
      # ============================================
      # 3. ä»£ç æ£€å‡º
      # ============================================
      - name: âœ… Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      # ============================================
      # 4. æ„å»ºä¾èµ–å®‰è£…
      # ============================================
      - name: ğŸ› ï¸ Build System Setup
        uses: sbwml/actions@openwrt-build-setup
        
      - name: ğŸ“¦ Install LLVM
        uses: sbwml/actions@install-llvm
      # ============================================
      # 5. æºç å‡†å¤‡
      # ============================================
      - name: ğŸ“¥ Prepare OpenWrt Source
        run: |
          echo "ğŸ”„ Cloning OpenWrt source..."
          rm -rf openwrt
          
          for attempt in 1 2 3; do
            if git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt; then
              break
            fi
            echo "âŒ Attempt $attempt failed, retrying..."
            rm -rf openwrt
            sleep 10
          done
          
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          
          # è·å–æºç å“ˆå¸Œ
          SOURCE_HASH=$(git rev-parse HEAD)
          echo "SOURCE_HASH=$SOURCE_HASH" >> $GITHUB_ENV
          
          # è·å–æäº¤ä¿¡æ¯
          COMMIT_INFO=$(git log -1 --pretty=format:'%an|%ci|%s|%H')
          IFS='|' read -r AUTHOR DATE MESSAGE HASH <<< "$COMMIT_INFO"
          {
            echo "COMMIT_AUTHOR=${AUTHOR}"
            echo "COMMIT_DATE=${DATE}"
            echo "COMMIT_MESSAGE=${MESSAGE}"
            echo "COMMIT_HASH=${HASH}"
          } >> $GITHUB_ENV
      # ============================================
      # 6. é«˜æ•ˆç¼“å­˜ç­–ç•¥
      # ============================================
      - name: â˜ï¸ Cache Downloads (æ°¸ä¹…)
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: downloads-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-v8
          restore-keys: |
            downloads-${{ env.REPO_BRANCH }}-
            downloads-
      - name: â˜ï¸ Cache Feeds
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/package/feeds
          key: feeds-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}-v3
          restore-keys: |
            feeds-${{ env.REPO_BRANCH }}-
      - name: â˜ï¸ Cache ccache (æ™ºèƒ½)
        if: github.event.inputs.force_clean != 'true'
        uses: actions/cache@v4
        with:
          path: openwrt/.ccache
          key: ccache-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-${{ env.SOURCE_HASH }}-v8
          restore-keys: |
            ccache-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-
            ccache-${{ env.REPO_BRANCH }}-
      - name: â˜ï¸ Cache Staging (åŸºäºæºç )
        if: github.event.inputs.force_clean != 'true' && github.event.inputs.use_prebuilt_toolchain != 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host*
            openwrt/staging_dir/hostpkg
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/host*
            openwrt/build_dir/toolchain-*
          key: staging-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}-v8
          restore-keys: |
            staging-${{ env.REPO_BRANCH }}-
      # ============================================
      # 7. é¢„ç¼–è¯‘å·¥å…·é“¾ä¸‹è½½
      # ============================================
      - name: ğŸ”§ Download Prebuilt Toolchain
        if: github.event.inputs.use_prebuilt_toolchain == 'true'
        run: |
          cd "$OPENWRT_PATH"
          echo "ğŸ” Looking for prebuilt toolchain..."
          
          # å°è¯•ä¸‹è½½é¢„ç¼–è¯‘å·¥å…·é“¾
          TOOLCHAIN_URL="https://github.com/${{ github.repository }}/releases/download/toolchain-${{ env.REPO_BRANCH }}/toolchain-x86_64-${{ env.SOURCE_HASH }}.tar.gz"
          
          if curl -fsSL "$TOOLCHAIN_URL" -o toolchain.tar.gz; then
            echo "âœ… Found prebuilt toolchain, extracting..."
            tar -xzf toolchain.tar.gz
            rm toolchain.tar.gz
            echo "TOOLCHAIN_PREBUILT=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ Prebuilt toolchain not found, will build from scratch"
            echo "TOOLCHAIN_PREBUILT=false" >> $GITHUB_ENV
          fi
      # ============================================
      # 8. Feeds é…ç½®
      # ============================================
      - name: ğŸ“š Configure Feeds
        run: |
          cd "$OPENWRT_PATH"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„feeds
          if [ ! -d "feeds" ] || [ -z "$(ls -A feeds 2>/dev/null)" ]; then
            echo "ğŸ”„ Updating feeds..."
            rm -rf feeds tmp/packagecache
            
            if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
              cp "${{ github.workspace }}/feeds.conf.default" .
            fi
            
            ./scripts/feeds update -a
            ./scripts/feeds install -a
          else
            echo "âœ… Using cached feeds"
            ./scripts/feeds install -a
          fi
      # ============================================
      # 9. ccache é…ç½®
      # ============================================
      - name: ğŸ”§ Setup ccache
        run: |
          cd "$OPENWRT_PATH"
          
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          
          mkdir -p "$CCACHE_DIR"
          
          # æ¿€è¿›çš„ccacheé…ç½®
          ccache -M 20G
          ccache -F 200000
          
          # é«˜çº§ä¼˜åŒ–è®¾ç½®
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache --set-config=stats=true
          ccache --set-config=max_files=200000
          ccache --set-config=sloppiness=file_macro,locale,time_macros,include_file_mtime
          ccache --set-config=hash_dir=false
          ccache --set-config=base_dir="$PWD"
          
          echo "ğŸ“Š ccache configuration:"
          ccache --show-config | head -20
          echo "ğŸ“Š Initial ccache stats:"
          ccache -s
      # ============================================
      # 10. é…ç½®åº”ç”¨
      # ============================================
      - name: ğŸ¨ Apply Custom Configuration
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker == 'true' && 'y' || 'n' }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp == 'true' && 'y' || 'n' }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall == 'true' && 'y' || 'n' }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki == 'true' && 'y' || 'n' }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash == 'true' && 'y' || 'n' }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky == 'true' && 'y' || 'n' }}
          ENABLE_OAF: ${{ github.event.inputs.oaf == 'true' && 'y' || 'n' }}
        run: |
          cd "$OPENWRT_PATH"
          
          # å¤åˆ¶é…ç½®å’Œè„šæœ¬
          cp "${{ github.workspace }}/$CONFIG_FILE" .config
          
          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi
          
          # ç”Ÿæˆé…ç½®
          make defconfig
          
          # æå–ç›®æ ‡ä¿¡æ¯
          DEVICE_TARGET=$(awk -F'"' '/^CONFIG_TARGET_BOARD=/{print $2}' .config || echo "x86")
          DEVICE_SUBTARGET=$(awk -F'"' '/^CONFIG_TARGET_SUBTARGET=/{print $2}' .config || echo "64")
          
          {
            echo "DEVICE_TARGET=$DEVICE_TARGET"
            echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET"
          } >> $GITHUB_ENV
      # ============================================
      # 11. ä¸‹è½½ä¾èµ–
      # ============================================
      - name: ğŸ“¥ Download Packages
        run: |
          cd "$OPENWRT_PATH"
          echo "ğŸ“¥ Downloading packages..."
          
          # æ™ºèƒ½ä¸‹è½½å¹¶è¡Œåº¦
          DOWNLOAD_JOBS=$((COMPILE_JOBS * 3))
          DOWNLOAD_JOBS=$((DOWNLOAD_JOBS > 32 ? 32 : DOWNLOAD_JOBS))
          
          make download -j"$DOWNLOAD_JOBS" || make download -j1
      # ============================================
      # 12. ç¼–è¯‘å›ºä»¶
      # ============================================
      - name: ğŸ”¨ Compile Firmware
        id: compile
        timeout-minutes: 360
        run: |
          cd "$OPENWRT_PATH"
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export CONFIG_CCACHE=y
          
          echo "ğŸ”¨ Starting compilation..."
          echo "ğŸ’¾ Available memory: $(free -h | grep '^Mem:' | awk '{print $7}')"
          echo "ğŸ”§ Using $COMPILE_JOBS jobs"
          echo "ğŸ“Š ccache stats (before):"
          ccache -s
          
          # æ™ºèƒ½ç¼–è¯‘ç­–ç•¥
          if [ "$TOOLCHAIN_PREBUILT" = "true" ]; then
            echo "ğŸš€ Using prebuilt toolchain, skipping tools/toolchain build"
            make -j"$COMPILE_JOBS" target/compile package/compile package/install || \
            make -j1 target/compile package/compile package/install V=s
          else
            echo "ğŸ”¨ Building everything from scratch"
            make -j"$COMPILE_JOBS" || make -j1 V=s
          fi
          
          echo "status=success" >> $GITHUB_OUTPUT
          
          echo "âœ… Compilation completed"
          echo "ğŸ“Š ccache stats (after):"
          ccache -s
      # ============================================
      # 13. ç¼“å­˜ç»Ÿè®¡
      # ============================================
      - name: ğŸ“Š Cache Statistics
        if: always()
        run: |
          cd "$OPENWRT_PATH"
          echo "=== ğŸ“Š Cache Effectiveness Report ==="
          echo "Date: $(date)"
          echo "Source Hash: ${{ env.SOURCE_HASH }}"
          echo "Plugins Hash: ${{ env.PLUGINS_HASH }}"
          echo ""
          
          echo "ğŸ“ Directory Sizes:"
          du -sh dl/ 2>/dev/null | sed 's/^/  /'
          du -sh .ccache/ 2>/dev/null | sed 's/^/  /'
          du -sh staging_dir/ 2>/dev/null | sed 's/^/  /'
          du -sh feeds/ 2>/dev/null | sed 's/^/  /'
          echo ""
          
          echo "ğŸ¯ ccache Statistics:"
          export CCACHE_DIR="$PWD/.ccache"
          ccache -s | grep -E "(cache hit|cache miss|hit rate)" | sed 's/^/  /'
          echo ""
          
          echo "ğŸ”§ Toolchain Status:"
          echo "  Prebuilt: ${TOOLCHAIN_PREBUILT:-false}"
          echo "================================="
      # ============================================
      # 14. æ•´ç†å›ºä»¶
      # ============================================
      - name: ğŸ“¦ Organize Firmware
        if: steps.compile.outputs.status == 'success'
        id: organize
        run: |
          cd "$OPENWRT_PATH/bin/targets"/*/*
          
          # è·å–å†…æ ¸ç‰ˆæœ¬
          KERNEL_VERSION="unknown"
          if ls *.manifest 1> /dev/null 2>&1; then
            KERNEL_VERSION=$(grep "^kernel " *.manifest | head -1 | awk '{print $3}' | cut -d- -f1-2 || echo "unknown")
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "$OPENWRT_PATH/.config" build.config
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯
          cat > firmware_info.json <<EOF
          {
            "build_date": "$BUILD_DATE",
            "build_version": "$BUILD_VERSION",
            "build_id": "$BUILD_ID",
            "kernel_version": "$KERNEL_VERSION",
            "source_hash": "$SOURCE_HASH",
            "toolchain_prebuilt": ${TOOLCHAIN_PREBUILT:-false},
            "target": "$DEVICE_TARGET",
            "subtarget": "$DEVICE_SUBTARGET",
            "lan_address": "${{ github.event.inputs.lan_addr }}",
            "plugins": {
              "docker": ${{ github.event.inputs.docker }},
              "ssrp": ${{ github.event.inputs.ssrp }},
              "passwall": ${{ github.event.inputs.passwall }},
              "openclash": ${{ github.event.inputs.openclash }},
              "nikki": ${{ github.event.inputs.nikki }},
              "lucky": ${{ github.event.inputs.lucky }},
              "oaf": ${{ github.event.inputs.oaf }}
            }
          }
          EOF
          
          {
            echo "firmware_path=$PWD"
            echo "kernel_version=$KERNEL_VERSION"
          } >> $GITHUB_OUTPUT
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
      # ============================================
      # 15. ä¸Šä¼ å’Œå‘å¸ƒ
      # ============================================
      - name: ğŸ“¤ Upload Artifacts
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_ARTIFACTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-${{ env.DEVICE_TARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 30
          compression-level: 6
      - name: ğŸš€ Create Release
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }} â€¢ ${{ env.FIRMWARE_TAG }} â€¢ Optimized
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## ğŸ¯ OpenWrt Firmware [${{ env.BUILD_ID }}] - Optimized Build
            
            ### ğŸ“Š æ„å»ºä¿¡æ¯
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | **æ—¥æœŸ** | `${{ env.BUILD_DATE }}` |
            | **ç›®æ ‡** | `${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}` |
            | **å†…æ ¸** | `${{ steps.organize.outputs.kernel_version }}` |
            | **æºç å“ˆå¸Œ** | `${{ env.SOURCE_HASH }}` |
            | **é¢„ç¼–è¯‘å·¥å…·é“¾** | `${TOOLCHAIN_PREBUILT:-false}` |
            | **LAN IP** | `${{ github.event.inputs.lan_addr }}` |
            | **å¯†ç ** | `${{ github.event.inputs.root_password }}` |
            
            ### ğŸš€ ä¼˜åŒ–ç‰¹æ€§
            - âœ… æ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼Œæé«˜å‘½ä¸­ç‡è‡³ 80%+
            - âœ… é¢„ç¼–è¯‘å·¥å…·é“¾æ”¯æŒï¼Œå¤§å¹…å‡å°‘ç¼–è¯‘æ—¶é—´
            - âœ… åŸºäºæºç å“ˆå¸Œçš„ç¨³å®šç¼“å­˜é”®
            - âœ… ä¼˜åŒ–çš„å†…å­˜å’Œå¹¶è¡Œåº¦é…ç½®
            
            ### ğŸ“¦ åŒ…å«çš„æ’ä»¶
            | æ’ä»¶ | çŠ¶æ€ |
            |------|------|
            | Docker | ${{ github.event.inputs.docker == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | ShadowSocksR Plus+ | ${{ github.event.inputs.ssrp == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Passwall | ${{ github.event.inputs.passwall == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenClash | ${{ github.event.inputs.openclash == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Nikki | ${{ github.event.inputs.nikki == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Lucky | ${{ github.event.inputs.lucky == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenAppFilter | ${{ github.event.inputs.oaf == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
