name: ğŸ’» Build OpenWrt (x86_64) - Ultimate

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      lan_addr:
        description: "ğŸ“ é»˜è®¤ LAN åœ°å€"
        default: "192.168.1.10"
        required: true
        type: string
      root_password:
        description: "ğŸ”‘ Root å¯†ç "
        default: "password"
        required: false
        type: string
      docker:
        description: "ğŸ‹ Docker æ”¯æŒ"
        type: boolean
        default: true
      ssrp:
        description: "ğŸš€ ShadowSocksR Plus+"
        type: boolean
        default: true
      passwall:
        description: "ğŸŒ Passwall"
        type: boolean
        default: true
      nikki:
        description: "ğŸ“¦ Nikki"
        type: boolean
        default: true
      openclash:
        description: "âš¡ OpenClash"
 type: boolean
        default: true
      lucky:
        description: "ğŸ€ Lucky"
       : boolean
        default: true
      oaf:
        description: "ğŸ›¡ï¸ OpenAppFilter"
        type: boolean
        default: true
      use_prebuilt_toolchain:
        description: "ğŸ”§ ä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾ (å®éªŒæ€§)"
        type: boolean
        default: false
      force_clean:
        description: "ğŸ§¹ å¼ºåˆ¶æ¸…ç†æ„å»ºç›®å½•"
        type: boolean
        default: false

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: configs/x86_64.config
  DIY_SCRIPT: scripts/diy-x86_64_demo.sh
  FEEDS_CONF: feeds.conf.default
  CLASH_KERNEL: amd64
  UPLOAD_ARTIFACTS: false
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: X86_64
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive

concurrency:
  group: build-${{ github.ref }}-${{ github.event.inputs.lan_addr }}
  cancel-in-progress: false

jobs:
  build:
    name: ğŸ—ï¸ Build OpenWrt
    runs-on: ubuntu-24.04
    timeout-minutes: 480

    outputs:
      firmware_path: ${{ steps.organize.outputs.firmware_path }}
      kernel_version: ${{ steps.organize.outputs.kernel_version }}

    steps:
      - name: ğŸ”§ Setup Environment Variables
        id: setup-env
        run: |
          sudo timedatectl set-timezone "$TZ"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

 VERSION=$(date +'%Y.%m.%d')
          BUILD_ID="${{ github.run_number }}-${GITHUB_SHA::7}"
          FILE_DATE=$(date +'%Y.%m.%d-%H%M')

          PROC_COUNT=$(nproc)
          MEM_GB=$(($(free -m | awk '/^Mem:/{print $2}') / 1024))
          JOBS=$((MEM_GB / 2))
          JOBS=$((JOBS > PROC_COUNT ? PROC_COUNT : JOBS))
          JOBS=$((JOBS < 1 ? 1 : JOBS))

          # æ’ä»¶çŠ¶æ€ä¸²
          PLUGINS_KEY="${{ github.event.inputs.docker }}-${{ github.event.inputs.ssrp }}-${{ github.event.inputs.passwall }}-${{ github.event.inputs.nikki }}-${{ github.event.inputs.openclash }}-${{ github.event.inputs.lucky }}-${{ github.event.inputs.oaf }}"
          PLUGINS_HASH=$(echo "$PLUGINS_KEY | sha256sum | cut -c1-8)

          WEEK_KEY=$(date +'%Y%U')

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "FILE_DATE=$FILE_DATE" >> $GITHUB_ENV
          echo "COMPILE_JOBS=$JOBS" >> $GITHUB_ENV
          echo "PLUGINS_HASH=$PLUGINS_HASH" >> $GITHUB_ENV
          echo "WEEK_KEY=$WEEK_KEY" >> $GITHUB_ENV

          echo "CPU CORES: $PROC_COUNT"
          echo "MEMORY GB: $MEM_GB"
          echo "COMPILE JOBS: $JOBS"
          echo "PLUGINS HASH: $PLUGINS_HASH"
          echo "EEK KEY: $WEEK_KEY"

      - name: ğŸ§¹ Free Disk Space
        uses: sbwml/actions@free-disk

      - name: ğŸ’¾ Setup Swap and Kernel Tuning
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo sw /swapfile

          sudo tee -a /etc/sysctl.conf >/dev/null <<EOF
          vm.swappiness=10
          vm.vfs_cache_pressure=50
          vm.dirty_ratio=15
          vm.dirty_background_ratio=5
          EOF
          sudo sysctl -p
          free -h

      - name: âœ… Checkout OpenWrt Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“¥ Clone OpenWrt Repo (retry)
        id: clone-source
        run: |
          rm -rf openwrt
          for i in {1..3}; do
            git clone --depth=1 --branch "$REPO_BRANCH" "$REPO_URL" openwrt && break
            echo "Clone failed, retrying..."
            sleep 10
          done
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          SOURCE_HASH=$(git rev-parse HEAD)
          echo "SOURCE_HASH=$SOURCE_HASH" >> $GITHUB_ENV
          COMMIT_INFO=$(git log -1 --pretty=format:"%an|%ci|%s|%H")
          IFS='|' read -r AUTHOR DATE MESSAGE HASH <<< "$COMMIT_INFO"
          echo "COMMIT_AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "COMMIT_DATE=$DATE" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$MESSAGE" >> $GITHUB_ENV
          echo "COMMIT_HASH=$HASH" >> $GITHUB_ENV

      # ============ ç¼“å­˜ç­–ç•¥ =============
      - name: â˜ï¸ Cache Downloads
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: downloads-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-v6
          restore-keys: |
            downloads-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-
            downloads-${{ env.REPO_BRANCH }}-

      - name: â˜ï¸ Cache Toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}-v7
          restore-keys: |
            toolchain-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}-
            toolchain-${{ env.REPO_BRANCH }}-

      - name: â˜ï¸ Cache Staging Directory
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host*
            openwrt/staging_dir/hostpkg
          key: staging-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}-v5
          restore-keys: |
            staging-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}-
            staging-${{ env.REPO_BRANCH }}-

      - name: â˜ï¸ Cache Build Host
        uses: actions/cache@v4
        with:
          path: openwrt/build_dir/host*
          key: buildhost-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-${{ env.WEEK_KEY }}-v5
          restore-keys: |
            buildhost-${{ env.REPO_BRANCH }}-${{ env.PLUGINS_HASH }}-
            buildhost-${{ env.REPO_BRANCH }}-

      - name: â˜ï¸ Cache ccache
        uses: actions/cache@v4
        with:
          path: openwrt/.ccache
          key: ccache-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}{ env.WEEK_KEY }}-v7
          restore-keys: |
            ccache-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}-
            ccache-${{ env.REPO_BRANCH }}-

      # ============= é¢„ç¼–è¯‘å·¥å…·é“¾ä¸‹è½½åŠåˆ¤æ–­ ==============
      - name: ğŸ”§ Download Prebuilt Toolchain (optional)
        if: github.event.inputs.use_prebuilt_toolchain == 'true'
        id: download-toolchain
        continue-on-error: true
        run: |
          cd "$OPENWRT_PATH"
          TOOLCHAIN_URL="https://github.com/${{ github.repository }}/releases/download/toolchain-${REPO_BRANCH}/toolchain-x86_64-${SOURCE_HASH}.tar.gz"
          echo "Trying to download prebuilt toolchain from $TOOLCHAIN_URL"
          if curl -fsSL --max-time 60 "$TOOLCHAIN_URL" -o toolchain.tar.gz; then
            echo "Toolchain downloaded, extracting..."
            if tar -xzf toolchain.tar.gz; then
              echo "TOOLCHAIN_PREBUILT=true" >> $GITHUB_ENV
              rm toolchain.tar.gz
              exit 0
            fi
          fi

          echo "Failed to get prebuilt toolchain"
          echo "TOOLCHAIN_PREBUILT=false" >> $GITHUB_ENV
          exit 1

      # ============ é…ç½® feeds ===============
      - name: ğŸ“š Configure Feeds
        run: |
          cd "$OPENWRT_PATH"
          rm -rf feeds tmp/packagecache
          if [ -f "${{ github.workspace }}/feeds.conf.default" ]; then
            cp "${{ github.workspace }}/feeds.conf.default" .
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ============= ccache é…ç½® =================
      - name: ğŸ”§ Setup ccache
        run: |
          cd "$OPENWRT_PATH"
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export PATH="/usr/lib/ccache:$PATH"

          mkdir -p "$CCACHE_DIR"

          ccache -M 15G
          ccache -F 150000
          ccache --set-config=compression=true
          ccache --set-config=stats=true
          ccache --set-config=max_files=150000
          ccache --set-config=sloppiness=file_macro,locale,time_macros

          echo "ccache config:"
          ccache -p
          ccache -s

      # ======= åº”ç”¨è‡ªå®šä¹‰é…ç½®åŠ defconfig ==========
      - name: ğŸ¨ Apply Custom Configuration
        env:
          LAN: ${{ github.event.inputs.lan_addr }}
          ROOT_PASSWORD: ${{ github.event.inputs.root_password }}
          ENABLE_DOCKER: ${{ github.event.inputs.docker == 'true' && 'y' || 'n' }}
          ENABLE_SSRP: ${{ github.event.inputs.ssrp == 'true' && 'y' || 'n' }}
          ENABLE_PASSWALL: ${{ github.event.inputs.passwall == 'true' && 'y' || 'n' }}
          ENABLE_NIKKI: ${{ github.event.inputs.nikki == 'true' && 'y' || 'n' }}
          ENABLE_OPENCLASH: ${{ github.event.inputs.openclash == 'true' && 'y' || 'n' }}
          ENABLE_LUCKY: ${{ github.event.inputs.lucky == 'true' && 'y' || 'n' }}
          ENABLE_OAF: ${{ github.event.inputs.oaf == 'true' && 'y' || 'n' }}
        run: |
          cd "$OPENWRT_PATH"
          [ -d "$GITHUB_WORKSPACE/files" ] && cp -r "$GITHUB_WORKSPACE/files" .
          cp "${{ github.workspace }}/$CONFIG_FILE" .config

          if [ -f "${{ github.workspace }}/$DIY_SCRIPT" ]; then
            chmod +x "${{ github.workspace }}/$DIY_SCRIPT"
            "${{ github.workspace }}/$DIY_SCRIPT"
          fi

          for s in preset-mihimo-core.sh preset-adguard-core.sh; do
            if [ -f "${{ github.workspace }}/scripts/$s" ]; then
              chmod +x "${{ github.workspace }}/scripts/$s"
              "${{ github.workspace }}/scripts/$s" "$CLASH_KERNEL"
            fi
          done

          make defconfig

          DEVICE_TARGET=$(awk -F'"' '/^CONFIG_TARGET_BOARD=/{print $2}' .config || echo "x86")
          DEVICE_SUBTARGET=$(awk -F'"' '/^CONFIG_TARGET_SUBTARGET=/{print $2}' .config || echo "64")
          echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
          echo "Prebuilt Toolchain Used: ${TOOLCHAIN_PREBUILT:-false}"

      # ===== å¼ºåˆ¶æ¸…ç† =========================
      - name: ğŸ§¹ Clean Build Directory
        if: github.event.inputs.force_clean == 'true'
        run: |
          cd "$OPENWRT_PATH"
          cp .config .config.backup
          make dirclean
          cp .config.backup .config
          make defconfig

      # ============ ä¸‹è½½åŒ… ====================
      - name: ğŸ“¥ Download
        run: |
          cd "$OPENWRT_PATH"
          DOWNLOAD_JOBS=$((COMPILE_JOBS < 16 ? COMPILE_JOBS * 2 : 16))
          if command -v aria2c >/dev/null 2>&1; then
            make download -j"$DOWNLOAD_JOBS" DOWNLOAD_TOOL="aria2c -x 4 -s 4" || make download -j1
          else
            make download -j"$DOWNLOAD_JOBS" || make download -j1
          fi

      # ============ ç¼–è¯‘ä»£ç  ==================
      - name: ğŸ”¨ Compile Firmware
        id: compile
        timeout-minutes: 360
        run: |
          cd "$OPENWRT_PATH"
          export USE_CCACHE=1
          export CCACHE_DIR="$PWD/.ccache"
          export CONFIG_CCACHE=y

          echo "Starting compilation with $COMPILE_JOBS jobs"
          echo "Prebuilt Toolchain Used: ${TOOLCHAIN_PREBUILT:-false}"

          echo "ccache stats before build:"
          ccache -s

          # ä¸‰é˜¶æ®µç¼–è¯‘ï¼Œä¿éšœæˆåŠŸç‡
          if make -j"$COMPILE_JOBS"; then
            echo "Parallel build succeeded"
          elif make -j1; then
            echo "Single-thread build succeeded"
          else
            echo "Parallel and single-thread build failed, retry with verbose"
            if make -j1 V=s; then
              echo "Verbose build succeeded"
            else
              echoBuild failed after all attempts"
              echo "=== Dirlist build_dir ==="
              ls -la build_dir/ | head -20
              echo "=== Recent logs ==="
              find . -name '*.log' -mmin -30 -exec tail -40 {} \;
              exit 1
            fi
          fi

          echo "ccache stats after build:"
          ccache -s

          echo "status=success" >> $GITHUB

      # ================ ç¼“å­˜çŠ¶æ€ç»Ÿè®¡ & å·¥å…·é“¾æ‰“åŒ… ===================
      - name: ğŸ“Š Cache Statistics & Toolchain Backup
 if: always()
        run: |
          cd "$OPENWRT_PATH"
          echo "Ultimate Cache Report:"
          echo "Date: $(date)"
          echo "Source Hash: $SOURCE_HASH"
          echo "Plugins Hash: $PLUGINS_HASH"
          echo "Week Key: $WEEK_KEY"
          echo ""

          for d in dl .ccache staging_dir build_dir/toolchain-* build_dir/host*; do
            if [ -d "$d" ]; then
              echo "Dir Size: $(du -sh $d)"
            fi
          done

          ccache -s | grep -E "(cache hit|cache miss|hit rate)" | sed 's/^/  /'

          HITS=$(ccache -s | grep "cache hit" | grep -o '[0-9]\+')
          MISSES=$(ccache -s | grep "cache miss" | grep -o '[0-9]\+')
          if [ -n "$HITS" ] && [ -n "$MISSES" ] && [ $((HITS + MISSES)) -gt 0 ]; then
            HIT_RATE=$((HITS * 100 / (HITS + MISSES)))
            echo "Calculated Hit Rate: ${HIT_RATE}%"
          fi

          echo "Build Summary:"
          echo "  Prebuilt Toolchain: ${TOOLCHAIN_PREBUILT:-false}"
          echo "  Compile Jobs: $COMPILE_JOBS"
          echo "  Build Status: ${{ steps.compile.outputs.status }}"

          # æ‰“åŒ…å·¥å…·é“¾ä¸ºä¸‹æ¬¡ç¼“å­˜åšå‡†å¤‡
          if [ "${TOOLCHAIN_PREBUILT:-false}" != "true" ]; then
            echo "Packing toolchain for future builds..."
            if [ -d "staging_dir/toolchain-x86_64_gcc-13.3.0_musl" ] && -d "build_dir/toolchain-x86_64_gcc-13.3.0_musl" ]; then
              tar -czf "../toolchain-x86_64-${SOURCE_HASH}.tar.gz" staging_dir/toolchain-* build_dir/toolchain-*
              echo "Toolchain archive size:"
              ls -lh "../toolchain-x86_64-${SOURCE_HASH}..gz"
            else
              echo "Toolchain directories not found, skipping packing"
            fi
          fi

      # ============= æ•´ç†å›ºä»¶ ===========
      - name: ğŸ“¦ Organize Firmware
        if: steps.compile.outputs.status == 'success'
        id: organize
       : |
          cd "$OPENWRT_PATH/bin/targets"/*/*
          echo "Generated Files:"
          ls -lah

          KERNEL_VERSION="unknown"
          if ls *.manifest 1> /dev 2>&1; then
            KERNEL_VERSION=$(grep "^kernel " *.manifest | head -1 | awk '{print $3}' | cut -d- -f1-2 || echo "unknown")
          fi

          cp "$OPENWRT_PATH/.config" build.config

          if [ -d packages ]; then
            tar -czf kernel-modules.tar.gz/
            rm -rf packages
          fi

          rm -f feeds.buildinfo version.buildinfo *.manifest

          cat > firmware_info.json <<EOF
{
  "build_date": "$BUILD_DATE",
  "build_version": "$VERSION",
  "build_id": "$BUILD_ID",
 "kernel_version": "$KERNEL_VERSION",
  "source_hash": "$SOURCE_HASH",
 toolchain_prebuilt": ${TOOLCHAIN_PREBUILT:-false},
  "target": "$DEVICE_TARGET",
  "subtarget": "$DEVICE_SUBTARGET",
  "lan_address": "${{ github.event.inputs.lan_addr }}",
  "plugins": {
    "docker": ${{ github.event.inputs.docker }},
    "ssrp": ${{ github.event.inputs.ssrp }},
passwall": ${{ github.event.inputs.passwall }},
    "openclash": ${{ github.event.inputs.openclash }},
    "nikki": ${{ github.event.inputs.nikki }},
    "lucky": ${{ github.event.inputs.lucky }},
    "oaf": ${{.event.inputs.oaf }}
  }
}
EOF

          echo "firmware_path=$PWD" >> $GITHUB_OUTPUT
          echo "kernel_version=$KERNEL_VERSION" >> $G_OUTPUT
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

      # ============== ä¸Šä¼ ä¸å‘å¸ƒ =============
      - name: ğŸ“¤ Upload Artifacts
 if: steps.compile.outputs.status == 'success' && env.UPLOAD_ARTIFACTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name:Wrt-${{ env.DEVICE_TARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 30
          compression-level: 6

      - name: ğŸš€ Create Release
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: ${{ env.FILE_DATE }} â€¢ ${{ env.FIRMWARE_TAG }} â€¢ Ultimate
          allowUpdates: true
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ## ğŸ¯ OpenWrt Firmware [${{ env.BUILD_ID }}] - Ultimate Build

            ### ğŸ“Š æ„å»ºä¿¡æ¯
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | **æ—¥æœŸ** | `${{ env.BUILD_DATE }}` |
            | **ç›®æ ‡** | `${{ env.DEVICE_TARGET }}_${{ env.DEVICE_SUBTARGET }}` |
            | **å†…æ ¸** | `${{ steps.organize.outputs.kernel_version }}` |
            | **æºç å“ˆå¸Œ** | `${{ env.SOURCE_HASH }}` |
            | **é¢„ç¼–è¯‘å·¥å…·é“¾** | `${{ env.TOOLCHAIN_PREBUILT:-false }}` |
            | **LAN IP** | `${{ github.event.inputs.lan_addr }}` |
            | **å¯†ç ** | `${{ github.event.inputs.root_password }}` |

            ### ğŸš€ ä¼˜åŒ–ç‰¹æ€§
            - âœ… ç¨³å®šä¸”ç»†åŒ–ç¼“å­˜ç­–ç•¥ï¼Œæå‡å‘½ä¸­ç‡
            - âœ… é¢„ç¼–è¯‘å·¥å…·é“¾å¤±è´¥å›é€€æºç ç¼–è¯‘
            - âœ… ä¸‰é˜¶æ®µç¼–è¯‘ä¿éšœæ„å»ºæˆåŠŸ
            - âœ… æ¿€è¿› ccache é…ç½®
            - âœ… å·¥å…·é“¾è‡ªåŠ¨æ‰“åŒ…å¤‡ä»½
            - âœ… é”™è¯¯æ¸…æ™°è¯Šæ–­æ—¥å¿—

            ### ğŸ“¦ æ’ä»¶çŠ¶æ€
            | æ’ä»¶ | çŠ¶æ€ |
            |------|------|
            | Docker | ${{ github.event.inputs.docker == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | ShadowSocksR Plus+ | ${{ github.event.inputs.ssrp == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Passwall | ${{ github.event.inputs.passwall == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenClash | ${{ github.event.inputs.openclash == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Nikki | ${{ github.event.inputs.nikki == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | Lucky | ${{ github.event.inputs.lucky == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
            | OpenAppFilter | ${{ github.event.inputs.oaf == 'true' && 'âœ… å·²ç¼–è¯‘' || 'âŒ æœªç¼–è¯‘' }} |
